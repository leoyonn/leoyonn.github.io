
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>mampa应用之——小米推送Fetcher服务性能调校 | Lyso™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="leoyonn">
    
    <meta name="description" content="背景小米消息推送系统在前不久开始使用MAMPA 进行异步化改造，改造的过程中，发现对hbase的读写是关键路径，而这一步骤是同步操作，与mampa的异步化框架是相悖的，可优化空间并不大，调试很久后性能甚至尚未达到原同步版：要么线程数开少了竞争不过其它的非异步化实例，要么线程数开太多导致load太高，">
    
    
    
    
    
    <link rel="icon" href="/img/leo.favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/Tinny.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/Tinny.jpg">
    

	
	<!--link href="http://cdn.bootcss.com/highlight.js/8.2/styles/railscasts.min.css" rel="stylesheet"-->
    <link href="/google-code-prettify/sunburst.css" type="text/css" rel="stylesheet" />
	<!--script src="http://cdn.bootcss.com/highlight.js/8.2/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script-->
	

    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Lyso™" title="Lyso™"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Lyso™">Lyso™</a></h1>
				<h2 class="blog-motto">理想主义者在现实中的舞步</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
                    <ul>
					 
						<li><a href="/">۩</a></li>
					
						<li><a href="/archives">⿳</a></li>
					
						<li><a href="/atom.xml">₨s</a></li>
					
						<li><a href="/about">㊙</a></li>
					
						<li><a href="/sitemap">∑</a></li>
					
					<li>
					
					</li>
                <li><div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div></li>

				</ul>
			</nav>	
</div>

    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/08/05/fetcher-mampa/" title="mampa应用之——小米推送Fetcher服务性能调校" itemprop="url">mampa应用之——小米推送Fetcher服务性能调校</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://lyso.me" title="leoyonn">leoyonn</a>
    </p>
  <p class="article-time">
    <time datetime="2014-08-05T13:22:11.000Z" itemprop="datePublished">2014-08-05</time>
    更新日期:<time datetime="2015-04-02T02:46:57.000Z" itemprop="dateModified">2015-04-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初步试验"><span class="toc-number">2.</span> <span class="toc-text">初步试验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实验环境："><span class="toc-number">2.1.</span> <span class="toc-text">实验环境：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验环境：-1"><span class="toc-number">2.2.</span> <span class="toc-text">实验环境：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验数据："><span class="toc-number">2.3.</span> <span class="toc-text">实验数据：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实验调校"><span class="toc-number">3.</span> <span class="toc-text">实验调校</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤1：qps=5000"><span class="toc-number">3.1.</span> <span class="toc-text">步骤1：qps=5000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤2：qps=8000"><span class="toc-number">3.2.</span> <span class="toc-text">步骤2：qps=8000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤3：qps=10000"><span class="toc-number">3.3.</span> <span class="toc-text">步骤3：qps=10000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤4：分析内存异常"><span class="toc-number">3.4.</span> <span class="toc-text">步骤4：分析内存异常</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤5：queue-size限制"><span class="toc-number">3.5.</span> <span class="toc-text">步骤5：queue-size限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤6：调整线程数"><span class="toc-number">3.6.</span> <span class="toc-text">步骤6：调整线程数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤7：qps=12000"><span class="toc-number">3.7.</span> <span class="toc-text">步骤7：qps=12000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤8：qps=15000"><span class="toc-number">3.8.</span> <span class="toc-text">步骤8：qps=15000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤9：比较不同redis线程数"><span class="toc-number">3.9.</span> <span class="toc-text">步骤9：比较不同redis线程数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤10：配置redis-mampa使用random-actor路由消息"><span class="toc-number">3.10.</span> <span class="toc-text">步骤10：配置redis-mampa使用random-actor路由消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤11：调整main/redis线程分配"><span class="toc-number">3.11.</span> <span class="toc-text">步骤11：调整main/redis线程分配</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后续工作"><span class="toc-number">4.</span> <span class="toc-text">后续工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#多优先级队列disruptor支持BlockingWaitStrategy"><span class="toc-number">4.1.</span> <span class="toc-text">多优先级队列disruptor支持BlockingWaitStrategy</span></a></li></ol></li></ol>
		</div>
		
		<p><img src="http://blog.xiaomi.com/wp-content/uploads/2014/03/mipush.jpg" alt=""></p>
<h3 id="背景">背景</h3><p>小米消息推送系统在前不久开始使用<a href="http://lyso.me/2014/02/01/mampa/" target="_blank" rel="external">MAMPA</a> 进行异步化改造，改造的过程中，发现对hbase的读写是关键路径，而这一步骤是同步操作，与mampa的异步化框架是相悖的，可优化空间并不大，调试很久后性能甚至尚未达到原同步版：要么线程数开少了竞争不过其它的非异步化实例，要么线程数开太多导致load太高，性能更差。</p>
<p>随后我们分析到hbase性能方面的问题后，参考<a href="https://www.usenix.org/system/files/conference/nsdi13/nsdi13-final170_update.pdf&amp;sa=U&amp;ei=gWJjU97pOeqxsQSDkYDAAg&amp;ved=0CBsQFjAA&amp;usg=AFQjCNGMeuWne9ywncbgux_XiZW6lQWHNw" target="_blank" rel="external">Scaling memcache at Facebook</a> <a href="http://qcontokyo.com/pdf/qcon_MarcKwiatkowski.pdf" target="_blank" rel="external">PPT</a> 设计了一套leased-cache，底层使用<a href="http://lyso.me/2014/03/10/redis-mampa/" target="_blank" rel="external">redis-mampa</a> （使用netty的异步化pipiline redis客户端）。</p>
<h3 id="初步试验">初步试验</h3><h4 id="实验环境：">实验环境：</h4><ul>
<li>hostA 作为压力测试客户端；</li>
<li>hostB 作为fetcher业务服务端；</li>
<li>hostC 作为redis、rabbitmq；</li>
<li>hostD 作为mysql；</li>
<li>Hbase访问采用mock数据并sleep一定时常方式；</li>
</ul>
<h4 id="实验环境：-1">实验环境：</h4><ul>
<li>HBase请求 sleep100ms左右；</li>
<li>Fetcher主逻辑线程6个、redis线程实验1/2/4/8个、hbase-mampa线程64个；</li>
</ul>
<h4 id="实验数据：">实验数据：</h4><ul>
<li>初始状态，cache里没有任何数据，请求全落到hbase：<ul>
<li>qps = 600，latency.99 =800ms</li>
</ul>
</li>
<li>以qps = 600将200w数据灌到redis中，模拟cache全命中情况：<ul>
<li>qps = 10000, latency.99 = 800ms，redis的latency.average在30ms左右</li>
<li>最大qps可以达到12000，此时查看数据生成导致mysql访问总是存在（mysql在主业务线程里访问，latency=0.5ms，6个线程qps峰值则为12000，后续可以通过mock 数据不需要访问mysql的情况来测试）</li>
</ul>
</li>
</ul>
<p>这里首先得到初步印象，latency的.99在800ms时，qps能达到10000，但没有获取到redis的latency.99以及这800ms的分布情况，而且有一个奇怪的现象是改变redis线程个数对结果影响不是太大，跟单独测试redis-mampa的性能情况不符。接下来进行更细致的实验和调校。</p>
<h3 id="实验调校">实验调校</h3><h4 id="步骤1：qps=5000">步骤1：qps=5000</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">6</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">5000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">wait~before~process.HIST-75-percentile</span>: <span class="string">86.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-95-percentile</span>: <span class="string">105.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-99-percentile</span>: <span class="string">118.71000000000004</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-999-percentile</span>: <span class="string">123.971</span></span><br><span class="line"></span><br><span class="line"><span class="stylus">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">73.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">115.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">142.71000000000004</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">191.942</span></span></span><br></pre></td></tr></table></figure>
<p>消息在系统中处理的总时间.99为142.71ms，latency是可以接受的，先看下这些时间的主要分布，之后增加qps后再放大地看是否存在问题：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">2.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">14.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">46.710000000000036</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">59.971000000000004</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">22.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">57.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">64.71000000000004</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">91.71000000000004</span></span><br><span class="line"></span><br><span class="line">(from tell是from send的超集，包括在actor的mailbox的时间）</span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">37.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">65.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">70.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">96.85500000000002</span></span><br></pre></td></tr></table></figure>
<h4 id="步骤2：qps=8000">步骤2：qps=8000</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">6</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">8000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">wait~before~process.HIST-75-percentile</span>: <span class="string">111.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-95-percentile</span>: <span class="string">142.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-99-percentile</span>: <span class="string">160.42000000000007</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-999-percentile</span>: <span class="string">164.971</span></span><br><span class="line"></span><br><span class="line"><span class="stylus">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">118.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">173.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">228.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">295.1880000000001</span></span></span><br></pre></td></tr></table></figure>
<p>消息在系统中处理的总时间.99为228ms，主要分布如下：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">4.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">26.549999999999955</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">74.97000000000025</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">99.0</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">49.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">165.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">196.71000000000004</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">207.0</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">81.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">174.54999999999995</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">204.42000000000007</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">210.0</span></span><br></pre></td></tr></table></figure>
<h4 id="步骤3：qps=10000">步骤3：qps=10000</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">6</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps =</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">131.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">227.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">463.5500000000002</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">499.884</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">2451.5</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">3307.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">3501.42</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">3581.980000000001</span></span><br></pre></td></tr></table></figure>
<p>消息在系统中处理的总时间.99飙升到3.5s，比之前初步实验时的情况还差，主要分布如下：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">43.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">330.2999999999997</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">699.0100000000011</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">1298.5780000000004</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">32.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">151.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">133294.30000000008</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">136519.942</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">57.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">310.3499999999983</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">133891.84</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">136521.681</span></span><br></pre></td></tr></table></figure>
<p>打到200w请求时，问题暴露出来了，这时发现内存飙升！<br><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="setting">load = <span class="value"><span class="number">5</span></span></span></span><br><span class="line"><span class="setting">mem=<span class="value"><span class="number">15</span>G</span></span></span><br></pre></td></tr></table></figure></p>
<h4 id="步骤4：分析内存异常">步骤4：分析内存异常</h4><p>重复实验几次后，大多数情况下都能重现内存暴涨的情况。于是通过 <a href="http://lyso.me/2014/07/01/bytebuf-memleak" target="_blank" rel="external">MAT分析java内存</a> 发现，redis-mampa内部的queue的size暴涨。这个queue是用来缓存pipiline发送到redis-server的命令以解析结果的发回给客户端的，当netty到redis-server这条通道的消息速度比客户端发来的慢时，就会导致queue堆积。</p>
<p>这就需要两个角度解决问题：</p>
<ol>
<li>需要对queue的size设置上限，在达到上限时降级服务，并打perf-counter</li>
<li>调查为何queue会堆积，因为qps没有达到实验性能</li>
</ol>
<h4 id="步骤5：queue-size限制">步骤5：queue-size限制</h4><p>加上 queue size 限制及perf：<br><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">6</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps =</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure></p>
<p>跑第一次时发现latency很小并且内存未涨，重复实验后又重现压力大的情况，但表现是：绝大多数请求因为redis超时和queue堆积而丢掉了（latency也很大）：<br><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line">redis~mampa~fail~<span class="built_in">queue</span>~<span class="literal">full</span><span class="built_in">.</span>COUNTER<span class="subst">=</span><span class="number">761222</span></span><br></pre></td></tr></table></figure></p>
<p>但查看redis-server的cpu/内存占用情况和机器load情况都无异常，猜测是由于主业务actor和redis-mampa的actor都是基于多优先级版disruptor的，用的SleepingWaitStrategy，这个等待策略先spin100次、再spin并yield100次、然后parkNanos，对CPU占用较大（由于是多优先级队列，不易使用BlockingWaitStrategy），于是将线程数改掉继续试验。</p>
<h4 id="步骤6：调整线程数">步骤6：调整线程数</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line"><span class="variable">qps =</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">133.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">167.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">175.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">196.942</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">131.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">201.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">249.71000000000004</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">260.913</span></span><br><span class="line"></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">5.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">29.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">55.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">114.59400000000005</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">58.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">109.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">156.71000000000004</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">171.971</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">67.75</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">116.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">167.1300000000001</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">172.0</span></span><br></pre></td></tr></table></figure>
<p>数据表示毫无压力，继续增加qps试试。</p>
<h4 id="步骤7：qps=12000">步骤7：qps=12000</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">12000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">144.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">166.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">181.71000000000004</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">195.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">128.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">214.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">296.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">316.942</span></span><br></pre></td></tr></table></figure>
<p>此时load=0.1，CPU=400%，latency.99在300ms，继续增加qps：</p>
<h4 id="步骤8：qps=15000">步骤8：qps=15000</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">15000</span></span><br></pre></td></tr></table></figure>
<p>在启动阶段load和CPU较高，latency也比较大，在打到60w-100w的时候latency降下来了：<br><code>mem=1.6G，CPU450%，load=3.0</code><br><code>rabbitmq.load=0.29, cpu=450%</code></p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">wait~before~process.HIST-75-percentile</span>: <span class="string">186.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-95-percentile</span>: <span class="string">223.54999999999995</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-99-percentile</span>: <span class="string">235.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-999-percentile</span>: <span class="string">250.0</span></span><br><span class="line"></span><br><span class="line"><span class="stylus">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">140.75</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">239.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">369.84000000000015</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">408.797</span></span></span><br></pre></td></tr></table></figure>
<p>但是latency相对较高，每次请求有两次redis的cmget请求，qps=15000时redis请求为30000，4个线程的实验数据要比这个好的多，所以猜测这里还有猫腻，降低redis线程数继续试验：</p>
<h4 id="步骤9：比较不同redis线程数">步骤9：比较不同redis线程数</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">2</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">2</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">15000</span></span><br></pre></td></tr></table></figure>
<p>的情况是：</p>
<p><code>mem=1.9G，CPU450%，load=4.0</code></p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">192.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">224.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">241.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">263.942</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">201.75</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">316.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">348.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">383.0</span></span><br></pre></td></tr></table></figure>
<p>而<br><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">2</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">15000</span></span><br></pre></td></tr></table></figure></p>
<p>的情况是：</p>
<p><code>mem=1.5G，CPU450%，load=0.3</code><br><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">183.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">216.54999999999995</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">378.1300000000001</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">416.65200000000004</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">90.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">160.54999999999995</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">241.42000000000007</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">312.942</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">53.75</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">198.54999999999995</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">250.84000000000015</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">266.971</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">69.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">198.0999999999999</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">262.5500000000002</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">270.0</span></span><br></pre></td></tr></table></figure></p>
<p>发现增加线程数的影响很小，进一步分析perf-counter，发现了redis的actor压力分布不均的情况，以下是redis线程分别是3、4、5的情况：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">mampa~tell~actor~RedisMampa~<span class="number">0</span>/<span class="number">3</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">743969</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">1</span>/<span class="number">3</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">2833514</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">2</span>/<span class="number">3</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">743539</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">mampa~tell~actor~RedisMampa~<span class="number">0</span>/<span class="number">4</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">155403</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">1</span>/<span class="number">4</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">156336</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">2</span>/<span class="number">4</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">155332</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">3</span>/<span class="number">4</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">758472</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">mampa~tell~actor~RedisMampa~<span class="number">0</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">620549</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">1</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">3686638</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">2</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">620688</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">3</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">620500</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">4</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">620516</span></span><br></pre></td></tr></table></figure>
<p>分析发现数字很有规律，总是有一个actor上落的比较多，其他的比较平均，多的数量是少的数量的(actor个数+1)倍，以上表5个actor为例，可以这样认为，有两种请求，第一种请求平均分给了5个actor，每个62w，第二种请求全落在actor-1上了，共306w，则actor-1上有368w个。然后意识到一种key是带userid的，另一种是appid的，这里测试app只有一个，所以落在了一个actor上。解决方案是，提供可配置的<code>random-actor</code>方式路由到不同的actor，继续试验。</p>
<h4 id="步骤10：配置redis-mampa使用random-actor路由消息">步骤10：配置redis-mampa使用random-actor路由消息</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">2</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">5</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">20000</span></span><br></pre></td></tr></table></figure>
<p>实验结果中redis的actor分布较均匀了。</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">mampa~tell~actor~RedisMampa~<span class="number">0</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">908895</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">1</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">907672</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">2</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">910176</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">3</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">910250</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">4</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">909681</span></span><br></pre></td></tr></table></figure>
<p>此时的latency为：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">21866.25</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">25688.65</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">26831.920000000002</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">27347.855</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">43.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">106.54999999999995</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">190.20000000000027</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">239.913</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">5.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">23.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">80.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">115.50700000000006</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">7.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">27.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">75.71000000000004</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">121.94200000000001</span></span><br><span class="line"></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">13.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">224.64999999999986</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">291.4200000000001</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">440.6220000000003</span></span><br></pre></td></tr></table></figure>
<p>可见redis的请求latency已经落回到合理的范围，但<code>wait~before~process</code>的时间很长，而且观察rabbitmq的状态发现fetcher模块整体produce的速度只有18000，而fetcher业务模块的disruptor占用情况为：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">mailbox~occupied~size~Fetcher~<span class="number">0</span><span class="class">.p1</span><span class="class">.GAUGE</span>=<span class="number">465</span></span><br><span class="line">mailbox~occupied~size~Fetcher~<span class="number">0</span><span class="class">.p2</span><span class="class">.GAUGE</span>=<span class="number">1859</span></span><br><span class="line">mailbox~occupied~size~Fetcher~<span class="number">1</span><span class="class">.p1</span><span class="class">.GAUGE</span>=<span class="number">533</span></span><br><span class="line">mailbox~occupied~size~Fetcher~<span class="number">1</span><span class="class">.p2</span><span class="class">.GAUGE</span>=<span class="number">1981</span></span><br></pre></td></tr></table></figure>
<p>因此猜测是main.thread成为了瓶颈，于是调整一下线程分配：</p>
<h4 id="步骤11：调整main/redis线程分配">步骤11：调整main/redis线程分配</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">20000</span></span><br></pre></td></tr></table></figure>
<p>此时<code>load=9, cpu=700%</code>，fetcher模块整体produce的速度基本达到了20000。</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">7854.75</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">11740.599999999999</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">16918.420000000013</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">18196.202</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">64.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">126.64999999999986</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">206.84000000000015</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">249.79700000000003</span></span><br><span class="line"></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">17.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">255.54999999999995</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">374.3900000000003</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">443.971</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">8.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">37.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">47.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">51.0</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">13.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">37.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">50.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">51.971000000000004</span></span><br></pre></td></tr></table></figure>
<p>但<code>wait~before~process</code>时间仍然较长，一部分原因是启动时就有堆积的延迟导致的，另外还需继续跟进的方面有：</p>
<h3 id="后续工作">后续工作</h3><ol>
<li>rabbitmq的CPU占用一直在500%上下，这里是否是瓶颈</li>
<li>能在多优先级队列的disruptor中支持更多的wait策略是否能解决load高的问题</li>
</ol>
<h4 id="多优先级队列disruptor支持BlockingWaitStrategy">多优先级队列disruptor支持BlockingWaitStrategy</h4><p>实验验证这种策略发现性能是有一定折扣的，</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="string">Blocking:</span>  Benchmark/Single <span class="string">Ellapsed:</span> <span class="number">3007.42</span>ms, <span class="string">QPS:</span> <span class="number">468862.87</span>. (producerCount=<span class="number">1</span>, ringSize=<span class="number">1024</span>, queries=<span class="number">10000000</span>). </span><br><span class="line"><span class="string">Blocking:</span>  Benchmark/Multi  <span class="string">Ellapsed:</span> <span class="number">6067.46</span>ms, <span class="string">QPS:</span> <span class="number">232398.09</span>. (priorities=[<span class="number">1000</span>, <span class="number">1000</span>], ringSize=<span class="number">1024</span>x2, queries=<span class="number">10000000</span>).</span><br><span class="line"><span class="string">Sleeping:</span>  Benchmark/Single <span class="string">Ellapsed:</span> <span class="number">1126.05</span>ms, <span class="string">QPS:</span> <span class="number">1252227.05</span>. (producerCount=<span class="number">1</span>, ringSize=<span class="number">1024</span>, queries=<span class="number">10000000</span>). </span><br><span class="line"><span class="string">Sleeping:</span>  Benchmark/Multi  <span class="string">Ellapsed:</span> <span class="number">1378.33</span>ms, <span class="string">QPS:</span> <span class="number">1023022.22</span>. (priorities=[<span class="number">1000</span>, <span class="number">1000</span>], ringSize=<span class="number">1024</span>x2, queries=<span class="number">10000000</span>).</span><br></pre></td></tr></table></figure>
<p>但我们肯定达不到20w+的qps，可以先不关心这个，试一下用BlockingWaitStrategy的Fetcher性能：</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="variable">load=</span><span class="number">5</span>, <span class="variable">mem=</span><span class="number">1.3</span>g, <span class="variable">CPU=</span><span class="number">700</span>%</span><br></pre></td></tr></table></figure>
<p>无请求时CPU由60%降到7%</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>=<span class="number">57.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>=<span class="number">80.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>=<span class="number">93.71000000000004</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>=<span class="number">106.91300000000001</span></span><br><span class="line"></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span>.HIST-<span class="number">75</span>-percentile=<span class="number">13.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span>.HIST-<span class="number">95</span>-percentile=<span class="number">51.549999999999955</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span>.HIST-<span class="number">99</span>-percentile=<span class="number">94.42000000000007</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span>.HIST-<span class="number">999</span>-percentile=<span class="number">181.56500000000005</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send.HIST-<span class="number">75</span>-percentile=<span class="number">5.0</span></span><br><span class="line">redis~mampa~from~send.HIST-<span class="number">95</span>-percentile=<span class="number">11.0</span></span><br><span class="line">redis~mampa~from~send.HIST-<span class="number">99</span>-percentile=<span class="number">20.0</span></span><br><span class="line">redis~mampa~from~send.HIST-<span class="number">999</span>-percentile=<span class="number">24.91300000000001</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell.HIST-<span class="number">75</span>-percentile=<span class="number">7.0</span></span><br><span class="line">redis~mampa~from~tell.HIST-<span class="number">95</span>-percentile=<span class="number">16.0</span></span><br><span class="line">redis~mampa~from~tell.HIST-<span class="number">99</span>-percentile=<span class="number">26.710000000000036</span></span><br><span class="line">redis~mampa~from~tell.HIST-<span class="number">999</span>-percentile=<span class="number">44.76800000000003</span></span><br></pre></td></tr></table></figure>
<p>OK，latency.99降到了100ms。</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/mampa/">mampa</a><a href="/tags/内存泄露/">内存泄露</a><a href="/tags/小米推送系统/">小米推送系统</a><a href="/tags/并发/">并发</a><a href="/tags/异步/">异步</a>
  </div>




<div class="article-share" id="share">

  
<div class="jiathis_style">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_tsina">新浪微博</a>
    <a class="jiathis_button_weixin">微信</a>
    <a class="jiathis_button_twitter">Twitter</a>
    <a class="jiathis_button_evernote">EverNote</a>
    <a href="http://www.jiathis.com/share?uid=1501277" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
</div>
<script type="text/javascript" >
    var jiathis_config={
    data_track_clickback:true,
    sm:"copy,renren,cqq",
    pic:"",
    summary:"",
    
  </script> 
<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=
" charset="utf-8"></script>      


</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/08/26/backpressure/" title="back pressure及reactive streams研究">
  <strong>PREVIOUS:</strong><br/>
  <span>
  back pressure及reactive streams研究</span>
</a>
</div>


<div class="next">
<a href="/2014/07/26/queue-threory-littles-law/"  title="排队理论及Little&#39;s Law">
 <strong>NEXT:</strong><br/> 
 <span>排队理论及Little&#39;s Law
</span>
</a>
</div>

</nav>

	
    <section id="comment">

        <h1 class="title">文章评论</h1>

        <!-- 多说评论框 start -->
        <div class="ds-thread" data-thread-key="2014/08/05/fetcher-mampa/" data-title="mampa应用之——小米推送Fetcher服务性能调校" data-url="http://lyso.me/2014/08/05/fetcher-mampa/"></div>
        <!-- 多说评论框 end -->

        <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
        <script type="text/javascript">
        var duoshuoQuery = {short_name:"leoyonn"};
    (function() {
     var ds = document.createElement('script');
     ds.type = 'text/javascript';ds.async = true;
     ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
     ds.charset = 'UTF-8';
     (document.getElementsByTagName('head')[0] 
      || document.getElementsByTagName('body')[0]).appendChild(ds);
     })();
    </script>
        <!-- 多说公共JS代码 end -->
        </section>
        


</div>  
      
  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初步试验"><span class="toc-number">2.</span> <span class="toc-text">初步试验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实验环境："><span class="toc-number">2.1.</span> <span class="toc-text">实验环境：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验环境：-1"><span class="toc-number">2.2.</span> <span class="toc-text">实验环境：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验数据："><span class="toc-number">2.3.</span> <span class="toc-text">实验数据：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实验调校"><span class="toc-number">3.</span> <span class="toc-text">实验调校</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤1：qps=5000"><span class="toc-number">3.1.</span> <span class="toc-text">步骤1：qps=5000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤2：qps=8000"><span class="toc-number">3.2.</span> <span class="toc-text">步骤2：qps=8000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤3：qps=10000"><span class="toc-number">3.3.</span> <span class="toc-text">步骤3：qps=10000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤4：分析内存异常"><span class="toc-number">3.4.</span> <span class="toc-text">步骤4：分析内存异常</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤5：queue-size限制"><span class="toc-number">3.5.</span> <span class="toc-text">步骤5：queue-size限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤6：调整线程数"><span class="toc-number">3.6.</span> <span class="toc-text">步骤6：调整线程数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤7：qps=12000"><span class="toc-number">3.7.</span> <span class="toc-text">步骤7：qps=12000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤8：qps=15000"><span class="toc-number">3.8.</span> <span class="toc-text">步骤8：qps=15000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤9：比较不同redis线程数"><span class="toc-number">3.9.</span> <span class="toc-text">步骤9：比较不同redis线程数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤10：配置redis-mampa使用random-actor路由消息"><span class="toc-number">3.10.</span> <span class="toc-text">步骤10：配置redis-mampa使用random-actor路由消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#步骤11：调整main/redis线程分配"><span class="toc-number">3.11.</span> <span class="toc-text">步骤11：调整main/redis线程分配</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后续工作"><span class="toc-number">4.</span> <span class="toc-text">后续工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#多优先级队列disruptor支持BlockingWaitStrategy"><span class="toc-number">4.1.</span> <span class="toc-text">多优先级队列disruptor支持BlockingWaitStrategy</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	
	<section class="author-info">
		
			<p> 送姜科技联合创始人/CTO</p>
		
		
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1821284675" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/leoyonn" target="_blank" title="github"></a>
		
		
	</div>
</div>
<aside class="clearfix">


  

  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">归档</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">六月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">五月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">三月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">十一月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/01/">一月 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/11/">十一月 2010</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/80后/" style="font-size: 10px;">80后</a><a href="/tags/ByteBuf/" style="font-size: 10px;">ByteBuf</a><a href="/tags/Dota/" style="font-size: 10px;">Dota</a><a href="/tags/FSM/" style="font-size: 15px;">FSM</a><a href="/tags/Google-Sync/" style="font-size: 10px;">Google Sync</a><a href="/tags/HBase/" style="font-size: 10px;">HBase</a><a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a><a href="/tags/Jekyll/" style="font-size: 10px;">Jekyll</a><a href="/tags/MAT/" style="font-size: 10px;">MAT</a><a href="/tags/NIO/" style="font-size: 10px;">NIO</a><a href="/tags/Netty/" style="font-size: 10px;">Netty</a><a href="/tags/PolledByteBufAllocator/" style="font-size: 10px;">PolledByteBufAllocator</a><a href="/tags/Reactive-Streams/" style="font-size: 10px;">Reactive Streams</a><a href="/tags/Redis/" style="font-size: 10px;">Redis</a><a href="/tags/actor模型/" style="font-size: 15px;">actor模型</a><a href="/tags/back-pressure/" style="font-size: 10px;">back pressure</a><a href="/tags/dpi/" style="font-size: 10px;">dpi</a><a href="/tags/erlang/" style="font-size: 15px;">erlang</a><a href="/tags/github-pages/" style="font-size: 10px;">github pages</a><a href="/tags/go/" style="font-size: 10px;">go</a><a href="/tags/golang/" style="font-size: 10px;">golang</a><a href="/tags/hbase-batch/" style="font-size: 10px;">hbase-batch</a><a href="/tags/java内存模型/" style="font-size: 15px;">java内存模型</a><a href="/tags/java线程模型/" style="font-size: 15px;">java线程模型</a><a href="/tags/jhat/" style="font-size: 10px;">jhat</a><a href="/tags/jmap/" style="font-size: 10px;">jmap</a><a href="/tags/little-s-law/" style="font-size: 10px;">little's law</a><a href="/tags/mampa/" style="font-size: 15px;">mampa</a><a href="/tags/netty/" style="font-size: 10px;">netty</a><a href="/tags/pixel/" style="font-size: 10px;">pixel</a><a href="/tags/ppi/" style="font-size: 10px;">ppi</a><a href="/tags/queueing-threory/" style="font-size: 10px;">queueing threory</a><a href="/tags/reactive-streams/" style="font-size: 10px;">reactive streams</a><a href="/tags/reactor/" style="font-size: 10px;">reactor</a><a href="/tags/redis-pipline/" style="font-size: 10px;">redis pipline</a><a href="/tags/resolution/" style="font-size: 10px;">resolution</a><a href="/tags/三体/" style="font-size: 12.5px;">三体</a><a href="/tags/丛林法则/" style="font-size: 12.5px;">丛林法则</a><a href="/tags/亚军/" style="font-size: 10px;">亚军</a><a href="/tags/人生/" style="font-size: 12.5px;">人生</a><a href="/tags/像素/" style="font-size: 10px;">像素</a><a href="/tags/内存泄露/" style="font-size: 12.5px;">内存泄露</a><a href="/tags/分辨率/" style="font-size: 10px;">分辨率</a><a href="/tags/创业/" style="font-size: 15px;">创业</a><a href="/tags/利特尔法则/" style="font-size: 10px;">利特尔法则</a><a href="/tags/喻华峰/" style="font-size: 10px;">喻华峰</a><a href="/tags/小米/" style="font-size: 10px;">小米</a><a href="/tags/小米推送系统/" style="font-size: 10px;">小米推送系统</a><a href="/tags/小米羽毛球联赛/" style="font-size: 10px;">小米羽毛球联赛</a><a href="/tags/并发/" style="font-size: 20px;">并发</a><a href="/tags/开源/" style="font-size: 17.5px;">开源</a><a href="/tags/异步/" style="font-size: 20px;">异步</a><a href="/tags/异步HBase客户端/" style="font-size: 10px;">异步HBase客户端</a><a href="/tags/异步Redis客户端/" style="font-size: 10px;">异步Redis客户端</a><a href="/tags/排队理论/" style="font-size: 10px;">排队理论</a><a href="/tags/无锁/" style="font-size: 10px;">无锁</a><a href="/tags/有限状态机/" style="font-size: 15px;">有限状态机</a><a href="/tags/本来生活/" style="font-size: 10px;">本来生活</a><a href="/tags/泊松过程/" style="font-size: 10px;">泊松过程</a><a href="/tags/现实/" style="font-size: 10px;">现实</a><a href="/tags/理想/" style="font-size: 10px;">理想</a><a href="/tags/生命/" style="font-size: 10px;">生命</a><a href="/tags/米莱/" style="font-size: 10px;">米莱</a><a href="/tags/羽毛球/" style="font-size: 10px;">羽毛球</a><a href="/tags/翻墙/" style="font-size: 10px;">翻墙</a><a href="/tags/职业规划/" style="font-size: 15px;">职业规划</a><a href="/tags/豆芽/" style="font-size: 10px;">豆芽</a><a href="/tags/负指数分布/" style="font-size: 10px;">负指数分布</a><a href="/tags/队列/" style="font-size: 10px;">队列</a><a href="/tags/马尔科夫链/" style="font-size: 10px;">马尔科夫链</a><a href="/tags/黑暗森林/" style="font-size: 12.5px;">黑暗森林</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
<script type="text/javascript" src="/google-code-prettify/prettify.js"></script>
<script type="text/javascript" src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
    $(window).load(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    })
</script>

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"lyso"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
