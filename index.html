<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Lyso as™ R&amp;D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Lyso as™ R&D">
<meta property="og:url" content="http://lyso.me/index.html">
<meta property="og:site_name" content="Lyso as™ R&D">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lyso as™ R&D">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="Lyso as™ R&amp;D" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Lyso as™ R&amp;D</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">理想主义者在现实中的舞步</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q" value="site:http://lyso.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/04/02/1/" class="article-date">
  <time datetime="2015-04-02T02:46:57.000Z" itemprop="datePublished">2015-04-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/02/1/">test</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight"><figcaption><span>[title] [] [url] [link text]</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code snippet</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2015/04/02/1/" data-id="ci7zkadvl0000r1580pndu0at" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/04/02/hello-world/" class="article-date">
  <time datetime="2015-04-02T02:22:53.000Z" itemprop="datePublished">2015-04-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/02/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2015/04/02/hello-world/" data-id="ci7zjzcxg0000mq58r9j96me3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-douya" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/02/douya/" class="article-date">
  <time datetime="2015-01-02T04:44:12.000Z" itemprop="datePublished">2015-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/02/douya/">小豆芽表情九连拍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="今天天气不错啊，想想我也出生快5天了，是不是留点什么纪念给未来的我看呀？">今天天气不错啊，想想我也出生快5天了，是不是留点什么纪念给未来的我看呀？</h4><p><img src="http://lyso.qiniudn.com/douya1.jpg" height="400"></p>
<hr>

<h4 id="哎呀_A_great_idea_hit_me！不如咱来一个表情九连拍？真是个好主意！">哎呀 A great idea hit me！不如咱来一个表情九连拍？真是个好主意！</h4><p><img src="http://lyso.qiniudn.com/douya2.jpg" height="400"></p>
<hr>

<h4 id="笑什么笑？说你呢！不相信我会摆表情啊？今天给你见见世面">笑什么笑？说你呢！不相信我会摆表情啊？今天给你见见世面</h4><p><img src="http://lyso.qiniudn.com/douya3.jpg" height="400"></p>
<hr>

<h4 id="等等，等等……我想一下，摆个什么表情好看呢？">等等，等等……我想一下，摆个什么表情好看呢？</h4><p><img src="http://lyso.qiniudn.com/douya4.jpg" height="400"></p>
<hr>

<h4 id="小酒窝/长睫毛/迷人的无可救药/我放慢了步调/感觉像是喝醉了">小酒窝/长睫毛/迷人的无可救药/我放慢了步调/感觉像是喝醉了</h4><p><img src="http://lyso.qiniudn.com/douya5.jpg" height="400"></p>
<hr>

<h4 id="非一般的表情控制能力不是说说就算了，看咱眯一只眼睛">非一般的表情控制能力不是说说就算了，看咱眯一只眼睛</h4><p><img src="http://lyso.qiniudn.com/douya6.jpg" height="400"></p>
<hr>

<h4 id="啊呀，说到眼睛，我出生时右眼皮皮上被护士阿姨弄痛了，当时担心留下疤疤，我哭的可伤心了">啊呀，说到眼睛，我出生时右眼皮皮上被护士阿姨弄痛了，当时担心留下疤疤，我哭的可伤心了</h4><p><img src="http://lyso.qiniudn.com/douya7.jpg" height="400"></p>
<hr>

<h4 id="算了算了还是不拍了，等我完全恢复了再来">算了算了还是不拍了，等我完全恢复了再来</h4><p><img src="http://lyso.qiniudn.com/douya8.jpg" height="400"></p>
<hr>

<h4 id="喔！嘻嘻嘻，算上这一张正好九连拍了，完成任务，粉丝们下期见喔。哦对了，我叫豆芽，我的粉丝叫啥呢？豆粥？">喔！嘻嘻嘻，算上这一张正好九连拍了，完成任务，粉丝们下期见喔。哦对了，我叫豆芽，我的粉丝叫啥呢？豆粥？</h4><p><img src="http://lyso.qiniudn.com/douya9.jpg" height="400"></p>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2015/01/02/douya/" data-id="ci7zkadxw003or158fqaennty" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/生命/">生命</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/米莱/">米莱</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/豆芽/">豆芽</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-reactor" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/08/27/reactor/" class="article-date">
  <time datetime="2014-08-27T10:44:12.000Z" itemprop="datePublished">2014-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/08/27/reactor/">reactor代码浅析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://lyso.qiniudn.com/reactor.jpg" alt=""></p>
<h2 id="简介">简介</h2><p>从<a href="http://lyso.me/2014/08/26/backpressure/" target="_blank" rel="external">Reactive-Streams</a> 的实现列表中看到了<a href="https://github.com/reactor/reactor/" target="_blank" rel="external">Reactor</a>， 但通读了其代码发现完全与reactor streams不沾边，而其做的事情与<a href="http://lyso.me/2014/02/01/mampa/" target="_blank" rel="external">MAMPA</a> 很接近，还是整理一下吧。</p>
<p>Reactor是一套在JVM上实现异步应用的框架，为Java、Groovy等JVM语言提供更便捷地搭建事件/数据驱动应用程序的底层抽象和接口，例如publish/consume事件。Reactor号称自己很快，在流行的硬件情况下，用其非阻塞Dispatcher吞吐能达到15,000,000的QPS。一个Reactor可以由多个不同的Dispatcher来实现，提交到Reactor的Task可以根据不同的配置而运行在Actor中的单个线程上/线程池中的一个线程/或LMAX Disruptor RingBuffer，如何配置可以根据业务类型来决定，比如阻塞IO操作用线程池，非阻塞快速计算用RingBuffer，等等。</p>
<h2 id="用法">用法</h2><p>可以参见其<a href="https://github.com/reactor/reactor/wiki/Usage-Guide" target="_blank" rel="external">Usage-Guide wiki</a>，简单来说，</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// <span class="number">1.</span> 创建一个环境</span><br><span class="line">final Environment env = new Environment();</span><br><span class="line"></span><br><span class="line">// <span class="number">2.</span> 通过环境创建一个Reactor</span><br><span class="line">Reactor r = Reactors.reactor().env(env).get();</span><br><span class="line"></span><br><span class="line">// <span class="number">3.</span> 告诉Reactor如何处理事件（指定handler，即Consumer）</span><br><span class="line">reactor.on($(<span class="string">"topic"</span>), new Consumer&lt;Event&lt;Message&gt;&gt;() &#123; <span class="keyword">...</span> &#125;);</span><br><span class="line"></span><br><span class="line">// <span class="number">4.</span> 向reactor中发送消息</span><br><span class="line">Message msg = msgService.nextMessage();</span><br><span class="line">reactor.notify(<span class="string">"topic"</span>, Event.wrap(msg));</span><br></pre></td></tr></table></figure>
<p>接下来按从整体到局部、从数据源头到尾的方式，简单分析其代码架构。</p>
<h2 id="Observable/Reactor">Observable/Reactor</h2><p>Reactor的接口定义为Observable，主要提供了三种接口。</p>
<h3 id="respondsToKey">respondsToKey</h3><p>查询是否这个key在Reactor中有对应的处理<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Are there any &#123;<span class="comment">@link Registration&#125;s with &#123;@link Selector Selectors&#125; that match the given &#123;@code key&#125;.</span></span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param key</span></span><br><span class="line"> <span class="keyword">*</span>         The key to be matched by &#123;<span class="comment">@link Selector Selectors&#125;</span></span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@return &#123;@literal true&#125; if there are any matching &#123;@literal Registration&#125;s, &#123;@literal false&#125; otherwise</span></span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line">boolean respondsToKey(Object key);</span><br></pre></td></tr></table></figure></p>
<h3 id="on">on</h3><p>将Consumer通过Selector注册到Reactor上，如果有消息到达Reactor并在Selector中match了，会发到这个Consumer。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Register a &#123;<span class="comment">@link reactor.function.Consumer&#125; to be triggered when a notification matches the given &#123;@link</span></span><br><span class="line"> <span class="keyword">*</span> Selector&#125;.</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param sel</span></span><br><span class="line"> <span class="keyword">*</span>         The &#123;<span class="comment">@literal Selector&#125; to be used for matching</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param consumer</span></span><br><span class="line"> <span class="keyword">*</span>         The &#123;<span class="comment">@literal Consumer&#125; to be triggered</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param &lt;E&gt;</span></span><br><span class="line"> <span class="keyword">*</span>         The type of the &#123;<span class="comment">@link reactor.event.Event&#125;</span></span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@return A &#123;@link Registration&#125; object that allows the caller to interact with the given mapping</span></span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line"><span class="variable">&lt;E extends Event&lt;?&gt;</span>&gt; Registration<span class="variable">&lt;Consumer&lt;E&gt;</span>&gt; on(Selector sel, Consumer<span class="variable">&lt;E&gt;</span> consumer);</span><br></pre></td></tr></table></figure>
<h3 id="notify">notify</h3><p>notify接口有很多种，大同小异，相当于MAMPA中的tell，告诉Reactor这个事件可以进行处理了，处理完后调用参数中consumer的onComplete。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> Notify this component that an &#123;<span class="comment">@link Event&#125; is ready to be processed and &#123;@link Consumer#accept accept&#125; &#123;@code</span></span><br><span class="line"> <span class="keyword">*</span> onComplete&#125; after dispatching.</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param key</span></span><br><span class="line"> <span class="keyword">*</span>         The key to be matched by &#123;<span class="comment">@link Selector Selectors&#125;</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param ev</span></span><br><span class="line"> <span class="keyword">*</span>         The &#123;<span class="comment">@literal Event&#125;</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param onComplete</span></span><br><span class="line"> <span class="keyword">*</span>         The callback &#123;<span class="comment">@link Consumer&#125;</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@param &lt;E&gt;</span></span><br><span class="line"> <span class="keyword">*</span>         The type of the &#123;<span class="comment">@link Event&#125;</span></span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@return &#123;@literal this&#125;</span></span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line"><span class="variable">&lt;E extends Event&lt;?&gt;</span>&gt; Observable notify(Object key, E ev, Consumer<span class="variable">&lt;E&gt;</span> onComplete);</span><br></pre></td></tr></table></figure>
<h3 id="Reactor中的成员">Reactor中的成员</h3><p>一个Reactor中管理着如下几种成员对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Dispatcher                             dispatcher;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Registry&lt;Consumer<span class="preprocessor">&lt;?</span> extends Event<span class="preprocessor">&lt;?</span>&gt;&gt;&gt; consumerRegistry;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventRouter                            eventRouter;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Consumer&lt;Throwable&gt;                    dispatchErrorHandler;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Consumer&lt;Throwable&gt;                    uncaughtErrorHandler;</span><br></pre></td></tr></table></figure>
<ul>
<li>当外部调用<code>on</code>接口时，会将Consumer的注册信息加入到<code>consumerRegistry</code>中去</li>
<li>一个事件通过<code>notify</code>接口发送到Reactor时，Reactor通过<code>dispatcher</code>进行处理，从<code>comsuerRegistry</code>中找到响应的consumer进行处理</li>
<li>dispatcher进行分发时，需要<code>eventRouter</code>做路由</li>
<li>在事件的分发过程中如果出现异常，会调用<code>dispatchErrorHandler</code>来处理</li>
<li>在Reactor初始化时会调用<code>on</code>注册一个单独的Selector<throwable>，使用<code>uncaughtErrorHandler</code>来处理</throwable></li>
</ul>
<h2 id="Dispatcher">Dispatcher</h2><p>Dispatcher中主要是一个<code>dispatch</code>接口，负责将事件分发到对应的consumers上。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    /<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line">     <span class="keyword">*</span> Instruct the &#123;<span class="comment">@code Dispatcher&#125; to dispatch the &#123;@code event&#125; that has the given &#123;@code key&#125;. The &#123;@link Consumer&#125;s</span></span><br><span class="line">     <span class="keyword">*</span> that will receive the event are selected from the &#123;<span class="comment">@code consumerRegistry&#125;, and the event is routed to them using</span></span><br><span class="line">     <span class="keyword">*</span> the &#123;<span class="comment">@code eventRouter&#125;. In the event of an error during dispatching, the &#123;@code errorConsumer&#125; will be called. In</span></span><br><span class="line">     <span class="keyword">*</span> the event of successful dispatching, the &#123;<span class="comment">@code completionConsumer&#125; will be called.</span></span><br><span class="line">     <span class="keyword">*</span></span><br><span class="line">     <span class="keyword">*</span> <span class="comment">@param key                The key associated with the event</span></span><br><span class="line">     <span class="keyword">*</span> <span class="comment">@param event              The event</span></span><br><span class="line">     <span class="keyword">*</span> <span class="comment">@param consumerRegistry   The registry from which consumer's are selected</span></span><br><span class="line">     <span class="keyword">*</span> <span class="comment">@param errorConsumer      The consumer that is invoked if dispatch fails. May be &#123;@code null&#125;</span></span><br><span class="line">     <span class="keyword">*</span> <span class="comment">@param eventRouter        Used to route the event to the selected consumers</span></span><br><span class="line">     <span class="keyword">*</span> <span class="comment">@param completionConsumer The consumer that is driven if dispatch succeeds May be &#123;@code null&#125;</span></span><br><span class="line">     <span class="keyword">*</span> <span class="comment">@param &lt;E&gt;                type of the event</span></span><br><span class="line">     <span class="keyword">*</span> <span class="comment">@throws IllegalStateException If the &#123;@code Dispatcher&#125; is not &#123;@link Dispatcher#alive() alive&#125;</span></span><br><span class="line">     <span class="keyword">*</span>/</span><br><span class="line">    <span class="variable">&lt;E extends Event&lt;?&gt;</span>&gt; void dispatch(Object key,</span><br><span class="line">                                                                         E event,</span><br><span class="line">                                                                         Registry<span class="variable">&lt;Consumer&lt;? extends Event&lt;?&gt;</span>&gt;&gt; consumerRegistry,</span><br><span class="line">                                                                         Consumer<span class="variable">&lt;Throwable&gt;</span> errorConsumer,</span><br><span class="line">                                                                         EventRouter eventRouter,</span><br><span class="line">                                                                         Consumer<span class="variable">&lt;E&gt;</span> completionConsumer);</span><br><span class="line">```                                                                          </span><br><span class="line"> </span><br><span class="line">在Reactor通过`notify`收到一个事件时，直接调用dispatcher的`dispatch`接口。在`dispatch`中，申请一个Task，然后提交执行：</span><br></pre></td></tr></table></figure>
<pre><code><span class="keyword">Task</span> <span class="keyword">task</span>;
<span class="keyword">boolean</span> isInContext = isInContext();
<span class="keyword">if</span> (isInContext) {
    <span class="keyword">task</span> = allocateRecursiveTask();
} <span class="keyword">else</span> {
    <span class="keyword">task</span> = allocateTask();
}

<span class="keyword">task</span>.setKey(key)
    .setEvent(event)
    .setConsumerRegistry(consumerRegistry)
    .setErrorConsumer(errorConsumer)
    .setEventRouter(eventRouter)
    .setCompletionConsumer(completionConsumer);

<span class="keyword">if</span> (isInContext) {
    addToTailRecursionPile(<span class="keyword">task</span>);
} <span class="keyword">else</span> {
    execute(<span class="keyword">task</span>);
}
</code></pre><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">至于提交执行的实现，视不同的不同的Dispatcher实现而异，Reactor中Dispatcher实现有很多种，如</span><br><span class="line"></span><br><span class="line">  <span class="keyword">*</span> ActorDispatcher</span><br><span class="line">  <span class="keyword">*</span> EventLoopDispatcher</span><br><span class="line">  <span class="keyword">*</span> RingBufferDispatcher</span><br><span class="line">  <span class="keyword">*</span> NettyEventLoopDispatcher</span><br><span class="line">  <span class="keyword">*</span> ThreadPoolExecutorDispatcher</span><br><span class="line">  <span class="keyword">*</span> WorkQueueDispatcher</span><br><span class="line"></span><br><span class="line">比如RingBufferDispatcher的`execute`是直接将Task丢到实现申请好的RingBuffer的slot中：</span><br></pre></td></tr></table></figure>
<pre><code><span class="keyword">protected</span> <span class="keyword">void</span> execute(<span class="keyword">Task</span> <span class="keyword">task</span>) {
    ringBuffer.publish(((RingBufferTask) <span class="keyword">task</span>).getSequenceId());
}
</code></pre><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">其Task中的sequenceId是在<span class="escape">`d</span>ispatch<span class="escape">`中</span><span class="escape">`a</span>llocateTask<span class="escape">`时</span>阻塞申请到的：</span><br></pre></td></tr></table></figure>
<pre><code><span class="function"><span class="keyword">protected</span> Task <span class="title">allocateTask</span><span class="params">()</span> </span>{
    <span class="keyword">long</span> seqId = ringBuffer.next();
    <span class="keyword">return</span> ringBuffer.<span class="keyword">get</span>(seqId).setSequenceId(seqId);
}
</code></pre><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后RingBuffer的消费线程会将ringBuffer中的Task依次消费执行。</span><br><span class="line"></span><br><span class="line">又如<span class="escape">`N</span>ettyEventLoopDispatcher<span class="escape">`则</span>更简单，直接将Task提交到Excutor上：</span><br></pre></td></tr></table></figure>
<pre><code><span class="keyword">protected</span> <span class="keyword">void</span> execute(<span class="keyword">Task</span> <span class="keyword">task</span>) {
    eventLoop.execute(<span class="keyword">task</span>);
}
</code></pre><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### <span class="keyword">Task</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Task</span>的执行是做了什么事情呢？调用EventRouter进行分发。</span><br></pre></td></tr></table></figure>
<pre><code><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> route(<span class="keyword">Task</span> <span class="keyword">task</span>) {
    <span class="keyword">if</span> (<span class="keyword">null</span> == <span class="keyword">task</span>.eventRouter) {
        <span class="keyword">return</span>;
    }
    <span class="keyword">try</span> {
        <span class="keyword">task</span>.eventRouter.route(
                <span class="keyword">task</span>.key,
                <span class="keyword">task</span>.event,
                (<span class="keyword">null</span> != <span class="keyword">task</span>.consumerRegistry ? <span class="keyword">task</span>.consumerRegistry.select(<span class="keyword">task</span>.key) : <span class="keyword">null</span>),
                <span class="keyword">task</span>.completionConsumer,
                <span class="keyword">task</span>.errorConsumer
        );
    } <span class="keyword">finally</span> {
        <span class="keyword">task</span>.recycle();
    }
}
</code></pre><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="preprocessor">## EventRouter</span></span><br><span class="line"></span><br><span class="line">EventRouter进行分发的逻辑如下（以ConsumerFilterEventRouter为例），首先过滤出所有符合要求的Registration列表：</span><br></pre></td></tr></table></figure>
<pre><code><span class="keyword">if</span> (<span class="keyword">null</span> != consumers &amp;&amp; !consumers.isEmpty()) {
    <span class="keyword">List</span>&lt;Registration<span class="preprocessor">&lt;?</span> extends Consumer<span class="preprocessor">&lt;?</span> extends Event<span class="preprocessor">&lt;?</span>&gt;&gt;&gt;&gt; regs = filter.filter(consumers, key);
</code></pre><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后对每一个Registration，调用其Selector的HeaderResolver将headers塞到event里，并调用<span class="escape">`C</span>onsumerInvoker<span class="escape">`的</span><span class="escape">`i</span>nvoke<span class="escape">`：</span></span><br></pre></td></tr></table></figure>
<pre><code><span class="keyword">int</span> <span class="keyword">size</span> = regs.<span class="keyword">size</span>();
<span class="comment">// old-school for loop is much more efficient than using an iterator</span>
<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">size</span>; i++) {
    Registration&lt;? <span class="keyword">extends</span> Consumer&lt;? <span class="keyword">extends</span> Event&lt;?&gt;&gt;&gt; reg = regs.get(i);

    <span class="keyword">if</span> (<span class="keyword">null</span> == reg || reg.isCancelled() || reg.isPaused()) {
        <span class="keyword">continue</span>;
    }
    <span class="keyword">try</span> {
        <span class="keyword">if</span> (<span class="keyword">null</span> != reg.getSelector().getHeaderResolver()) {
            event.getHeaders().setAll(reg.getSelector().getHeaderResolver().resolve(key));
        }
        consumerInvoker.invoke(reg.getObject(), <span class="keyword">Void</span>.TYPE, event);
</code></pre><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在出现问题时如果遇到CancelConsumerException则将Registration取消，对其他异常调用<span class="escape">`e</span>rrorConsumer<span class="escape">`进</span>行处理。</span><br></pre></td></tr></table></figure>
<pre><code>        } <span class="keyword">catch</span> (CancelConsumerException cancel) {
            reg.cancel();
        } <span class="keyword">catch</span> (Throwable t) {
            <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">event</span>.getErrorConsumer()) {
                <span class="keyword">event</span>.consumeError(t);
            } <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(<span class="keyword">null</span> != errorConsumer)</span> </span>{
                errorConsumer.accept(t);
            } <span class="keyword">else</span> {
                logger.error(<span class="string">"Event routing failed for {}: {}"</span>, reg.getObject(), t.getMessage(), t);
                <span class="keyword">if</span> (RuntimeException.class.isInstance(t)) {
                    <span class="keyword">throw</span> (RuntimeException) t;
                } <span class="keyword">else</span> {
                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(t);
                }
            }
        } <span class="keyword">finally</span> {
            <span class="keyword">if</span> (reg.isCancelAfterUse()) {
                reg.cancel();
            }
        }
    }
}
</code></pre><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">完成转发后如果<span class="escape">`c</span>ompletionConsumer<span class="escape">`存</span>在则执行其accept：</span><br></pre></td></tr></table></figure>
<pre><code><span class="keyword">if</span> (null != completionConsumer) {
    try {
        consumerInvoker.invoke(completionConsumer, Void.<span class="keyword">TYPE</span>, event);
    } catch (Exception <span class="keyword">e</span>) {
        <span class="keyword">if</span> (null != errorConsumer) {
            errorConsumer.accept(<span class="keyword">e</span>);
        } <span class="keyword">else</span> {
            logger.<span class="keyword">error</span>(<span class="string">"Completion Consumer {} failed: {}"</span>, completionConsumer, <span class="keyword">e</span>.getMessage(), <span class="keyword">e</span>);
        }
    }
}
</code></pre><p>}<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## Registry、Registration</span><br><span class="line"></span><br><span class="line">一个Registry管理一个Reactor中所有的Regitration，可以认为它就是一个Registration的List，有接口<span class="escape">`r</span>egister<span class="escape">`，</span><span class="escape">`u</span>nregister<span class="escape">`，</span><span class="escape">`c</span>lear<span class="escape">`：</span></span><br></pre></td></tr></table></figure></p>
<pre><code>/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> Assign the given {<span class="comment">@link reactor.event.selector.Selector} with the given object.</span>
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@param sel The left-hand side of the {@literal Selector} comparison check.</span>
 <span class="keyword">*</span> <span class="comment">@param obj The object to assign.</span>
 <span class="keyword">*</span> <span class="comment">@return {@literal this}</span>
 <span class="keyword">*</span>/
<span class="variable">&lt;V extends T&gt;</span> Registration<span class="variable">&lt;V&gt;</span> register(Selector sel, V obj);

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> Remove any objects matching this {<span class="comment">@code key}. This will unregister &lt;b&gt;all&lt;/b&gt; objects matching the given</span>
 <span class="keyword">*</span> {<span class="comment">@literal key}. There's no provision for removing only a specific object.</span>
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@param key The key to be matched by the Selectors</span>
 <span class="keyword">*</span> <span class="comment">@return {@literal true} if any objects were unassigned, {@literal false} otherwise.</span>
 <span class="keyword">*</span>/
boolean unregister(Object key);

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> Select {<span class="comment">@link Registration}s whose {@link Selector} {@link Selector#matches(Object)} the given {@code key}.</span>
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@param key The key for the Selectors to match</span>
 <span class="keyword">*</span> <span class="comment">@return A {@link List} of {@link Registration}s whose {@link Selector} matches the given key.</span>
 <span class="keyword">*</span>/
List<span class="variable">&lt;Registration&lt;? extends T&gt;</span>&gt; select(Object key);

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> Clear the {<span class="comment">@link Registry}, resetting its state and calling {@link Registration#cancel()} for any active {@link</span>
 <span class="keyword">*</span> Registration}.
 <span class="keyword">*</span>/
void clear();
</code></pre><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">可以看到，<span class="escape">`r</span>egister<span class="escape">`接</span>口会返回<span class="escape">`R</span>egistration<span class="escape">`，</span>Registration描述了一个<span class="escape">`S</span>elector<span class="escape">`和</span>一个<span class="escape">`C</span>onsumer<span class="escape">`的</span>对应关系，有<span class="escape">`g</span>etSelector<span class="escape">`，</span><span class="escape">`g</span>etObject<span class="escape">`，</span><span class="escape">`c</span>ancel<span class="escape">`等</span>接口，其中getObject就是获取Consumer：</span><br></pre></td></tr></table></figure>
<pre><code>/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> The {<span class="comment">@link reactor.event.selector.Selector} that was used when the registration was made.</span>
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@return the registration's selector</span>
 <span class="keyword">*</span>/
Selector getSelector();

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> The object that was registered
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@return the registered object</span>
 <span class="keyword">*</span>/
T getObject();

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> Cancel this {<span class="comment">@literal Registration} by removing it from its registry.</span>
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@return {@literal this}</span>
 <span class="keyword">*</span>/
<span class="comment">@Override</span>
Registration<span class="variable">&lt;T&gt;</span> cancel();
</code></pre><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在Reactor中的`<span class="function_start"><span class="keyword">on</span></span>`接口中就是执行了注册操作：</span><br></pre></td></tr></table></figure>
<pre><code>public &lt;<span class="keyword">E</span> extends Event&lt;?&gt;&gt; Registration&lt;Consumer&lt;<span class="keyword">E</span>&gt;&gt; <span class="keyword">on</span>(Selector selector, final Consumer&lt;<span class="keyword">E</span>&gt; consumer) {
    <span class="keyword">Assert</span>.notNull(selector, <span class="string">"Selector cannot be null."</span>);
    <span class="keyword">Assert</span>.notNull(consumer, <span class="string">"Consumer cannot be null."</span>);
    Registration&lt;Consumer&lt;<span class="keyword">E</span>&gt;&gt; <span class="keyword">reg</span> = consumerRegistry.register(selector, consumer);
    <span class="keyword">return</span> <span class="keyword">reg</span>;
}
</code></pre><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">而在Registry的<span class="escape">`s</span>elect<span class="escape">`接</span>口中，就是通过遍历其Registration的Selector的match来找到Registration列表来实现的：</span><br></pre></td></tr></table></figure>
<pre><code><span class="annotation">@Override</span>
public <span class="built_in">List</span>&lt;Registration&lt;? <span class="keyword">extends</span> T&gt;&gt; select(<span class="built_in">Object</span> key) {
    <span class="comment">// maybe pull Registrations from cache for this key</span>
    <span class="built_in">List</span>&lt;Registration&lt;? <span class="keyword">extends</span> T&gt;&gt; selectedRegs = FastList.newList();

    <span class="comment">// find Registrations based on Selector</span>
    <span class="keyword">for</span> (Registration&lt;? <span class="keyword">extends</span> T&gt; reg : <span class="keyword">this</span>) {
        <span class="keyword">if</span> (reg.getSelector().matches(key)) {
            selectedRegs.add(reg);
        }
    }

    <span class="comment">// nothing found, maybe invoke handler</span>
    <span class="keyword">if</span> (selectedRegs.isEmpty() &amp;&amp; <span class="keyword">null</span> != onNotFound) {
        onNotFound.accept(key);
    }

    <span class="comment">// return</span>
    <span class="keyword">return</span> selectedRegs;
}
</code></pre><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## Selector</span><br><span class="line"></span><br><span class="line">Selector的接口就不言自明了，需要提供<span class="escape">`m</span>atch<span class="escape">`和</span><span class="escape">`g</span>etHeaderResolver<span class="escape">`：</span></span><br></pre></td></tr></table></figure>
<pre><code>/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> Indicates whether this Selector matches the {<span class="comment">@code key}.</span>
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@param key The key to match</span>
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@return {@code true} if there's a match, otherwise {@code false}.</span>
 <span class="keyword">*</span>/
boolean matches(Object key);

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> Return a component that can resolve headers from a key
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@return A {@link HeaderResolver} applicable to this {@link Selector} type.</span>
 <span class="keyword">*</span>/
HeaderResolver getHeaderResolver();
</code></pre><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="preprocessor">## Consumer</span></span><br><span class="line"></span><br><span class="line">最后我们到了Consumer，看它的接口：</span><br></pre></td></tr></table></figure>
<p>/**</p>
<ul>
<li>Implementations accept a given value and perform work on the argument.<br>*</li>
<li>@author Jon Brisbin</li>
<li>@author Stephane Maldini<br>*</li>
<li><p>@param <t> the type of values to accept<br>*/<br>public interface Consumer<t> {</t></t></p>
<p> /**</p>
<ul>
<li>Execute the logic of the action, accepting the given parameter.<br>*</li>
<li>@param t The parameter to pass to the consumer.<br>*/<br>void accept(T t);</li>
</ul>
</li>
</ul>
<p>}<br>```</p>
<h2 id="Reactor_vs-_Mampa">Reactor vs. Mampa</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2014/08/27/reactor/" data-id="ci7zkadwz001ir158u9em3tp9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mampa/">mampa</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reactive-streams/">reactive streams</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reactor/">reactor</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发/">并发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开源/">开源</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/异步/">异步</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-backpressure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/08/26/backpressure/" class="article-date">
  <time datetime="2014-08-26T10:44:12.000Z" itemprop="datePublished">2014-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/08/26/backpressure/">back pressure及reactive streams研究</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://lyso.qiniudn.com/backpressure.png" alt="back pressure-图片来自akka"></p>
<h2 id="引子">引子</h2><p>　　随着<a href="http://lyso.me/2014/02/01/mampa/" target="_blank" rel="external">Mampa</a> 越来越多的应用在线上系统中，我们在逐步优化同时，发现一个很难绕过去的问题。一个系统中可能有多个ActorGroup，每个ActorGroup中负责一中业务类型（或层次）。比如：</p>
<ul>
<li>FetchActor中负责fetch消息的接收、处理、发回</li>
<li>RedisActor中负责消息中与redis请求相关的操作，发请求到redis-server并把server的返回结果解码后返回给FetchActor</li>
<li>HBaseActor同RedisActor，负责处理HBase相关请求</li>
<li>KakfaActor负责处理与Kafka相关的请求</li>
</ul>
<p>　　如果当前HBase性能较差，RedisActor又没有挡住大量的请求，而FetchActor中过来的消息太快，根据<a href="http://lyso.me/2014/07/26/queue-threory-littles-law/" target="_blank" rel="external">排队理论</a> 中所述，对于HBaseActor这样一个子系统来说，如果消息到达速率 &gt; 服务速率，这就不是一个稳定的系统，会导致Queue快速增长，直至内存爆掉或达到保护上限。到此上限后怎么处理更多的请求：</p>
<ul>
<li>丢弃</li>
<li>将压力向上反馈到源头</li>
</ul>
<p>　　第二种方法，就是我们所要系统考虑的back pressure。</p>
<h2 id="什么是back_pressure">什么是back pressure</h2><p>　　这种情况一般成为“持续压力”（sustained load），如果系统设计时不慎重考虑过载的情况，可能造成的结果是完全无法服务。如果请求量超过了系统的处理能力，就是要做取舍决定的时候了：Something has to give。比较理想的降级服务方法是，让系统仍以正常的latency、以最高的吞吐运行，而高于这个吞吐的那部分请求就拒绝服务好了。</p>
<p>　　举一个过载例子。小米公司每周四都去奥体打羽毛球，8-10块场地，每块场地都&gt;8个人，打起来都觉得等的时间长，汗都出不来，再加上2B的奥体服务态度，忒不爽了。如果采用报名制，每个场地报名6人，报名晚的就只能自己想办法了——比如自己花个钱定场地，那结果是绝得大多数都玩的爽。（当然不久后场地会换到西三旗伟士，没有2B管理员后打的会更爽）</p>
<p>　　什么是“Back Pressure”呢？再比如小米食堂里有500个座位，平均每人吃饭30min，如果同时有超过500个人到食堂，那就得有人等座，再加上饭菜不好吃肯定给差评了。如果可以即时在门口放一个牌子，显示已经进去了多少人（减去已经吃完出来的，就像很多车库的电子指示牌一样），发现食堂比较满的人就可以先不进去，去大桥上溜溜弯，去小米之家看会“万万想不到”，去咖啡厅坐会聊聊天…… 这样食堂里面正在吃饭的也觉得环境宽松，心情不错。根据Little’s Law，食堂不能服务超过每小时1000人，如果12:00-12:30有600人来吃饭，那就有100人在咖啡厅或其它地方消遣。在线上系统亦是如此，超过系统处理能力的部分如果能及时反馈到咖啡厅、大桥上，就是实现了BackPressure。</p>
<h2 id="什么是reactive_streams">什么是reactive streams</h2><p>　　Reactive Streams 是一个在JVM上提供有非阻塞Back-Pressure能力的异步数据流的计划。</p>
<h3 id="要解决的问题">要解决的问题</h3><p>　　处理实时数据流在异步系统里尤其需要小心，其中最主要的问题是在数据流的入口需要控制好不至于后续阶段中被冲垮。</p>
<p>　　Reactive streams的主要目标是在“异步边界”上控制数据流的流量，例如把数据传输给另一个线程或线程池时需要确保其不会buffer溢出。换句话说，Back Pressure 是整个模型中重要的环节以确保队列大小的可控（<a href="http://lyso.me/2014/07/26/queue-threory-littles-law/" target="_blank" rel="external">队列：稳定的系统</a>）。 如果Back Pressure是同步的，那整个系统的异步带来的好处就不存在了。</p>
<h3 id="First_Draft_Specification">First Draft Specification</h3><p>Available immediately is a First Draft Specification covering:</p>
<ul>
<li><a href="https://github.com/reactive-streams/reactive-streams/blob/v0.3/tck/src/main/resources/spec.md" target="_blank" rel="external">Semantics</a> —a specification document</li>
<li><a href="https://github.com/reactive-streams/reactive-streams/tree/v0.3/spi/src/main/java/org/reactivestreams/api/" target="_blank" rel="external">API</a> —Java interfaces for end users</li>
<li><a href="https://github.com/reactive-streams/reactive-streams/tree/v0.3/spi/src/main/java/org/reactivestreams/spi/" target="_blank" rel="external">SPI</a> —Java interfaces for implementations</li>
<li><a href="https://github.com/reactive-streams/reactive-streams/tree/v0.3/tck/src/main/java/org/reactivestreams/tck/" target="_blank" rel="external">TCK</a> —a test harness to validate implementations and guide implementors<br>All of the parts of the Draft Proposal is released under Creative Commons Zero (Public Domain).</li>
</ul>
<h3 id="Implementations_of_the_draft_spec">Implementations of the draft spec</h3><ul>
<li>Akka Streams<ul>
<li>See this Activator template introducing the Akka Project implementation in Scala; a Java version will follow shortly.</li>
<li>Please give Feedback on the issue tracker.</li>
</ul>
</li>
<li>Reactor Composable<ul>
<li><a href="http://github.com/reactor/reactor" target="_blank" rel="external">Reactor (1.1+)</a></li>
<li>Current Implementation Draft is being explored for 1.1 and onwards, see Reactor Composable</li>
</ul>
</li>
<li>RxJava<ul>
<li>Support being prototyped and explored for inclusion in RxJava 1.0<h3 id="Implementors">Implementors</h3></li>
</ul>
</li>
</ul>
<p>To get started implementing the draft specification, it is recommended to start by reading the README, then taking a look at the Specification then taking a look at the TCK. If you have an issue with any of the above, please take a look at closed issues and then open a new issue if it has not already been answered.</p>
<h2 id="接口定义">接口定义</h2><p>　　Reactive Streams的接口分为两种，用户使用的接口和实现使用的接口。</p>
<p>　　用户实现的接口包括Producer、Consumer、Processor，实现使用的接口包括Publisher、Subscriber、Subscription。</p>
<h3 id="Producer">Producer</h3><p>　　Producer是消息源，底层实现使用Publisher。Producer中有2个接口，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Producer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Publisher&lt;T&gt; <span class="title">getPublisher</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produceTo</span><span class="params">(Consumer&lt;T&gt; consumer)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>getPublisher：获取底层实现的Publisher</li>
<li>produceTo：将制定的consumer连接到此producer上，在底层实现上需要让consumer去subscribe这个producer的publisher，之后producer产生的stream就能一直被这个consumer消费了，直到以下情况之一：<ul>
<li>Stream里没有数据了</li>
<li>Producer抛异常了</li>
<li>Consumer取消接收更多消息</li>
</ul>
</li>
</ul>
<h3 id="Consumer">Consumer</h3><p>　　Consumer消费消息的stream，由Subscriber实现，只提供一个getSubscriber接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Consumer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Subscriber&lt;T&gt; <span class="title">getSubscriber</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Processor">Processor</h3><p>　　Processor包含了Producer和Consumer的功能，consume <i>类型的消息，produce <o>类型的消息：</o></i></p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Processor</span>&lt;<span class="title">I</span>, <span class="title">O</span>&gt; <span class="keyword">extends</span> <span class="title">Consumer</span>&lt;<span class="title">I</span>&gt;, <span class="title">Producer</span>&lt;<span class="title">O</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Publisher">Publisher</h3><p>　　Publisher是消息源，一个或多个Subscriber会连接到publisher上接收publisher产生的消息，通过Subscription的<code>requestMore</code>接口来决定是否生成更多消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Publisher</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;T&gt; subscriber)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Subscriber">Subscriber</h3><p>　　Subscriber从Publisher接收消息，通过Subscription的<code>requestMore</code>接口向publisher提交“需求”，只有当“需求”和publisher的消息都有的情况下才会接收到更多消息。</p>
<p>　　Subscriber被传送到Publisher进行subscribe时，如果producer接受此subscribe，会调用<code>onSubscribe</code>接口，如果拒绝会调用<code>onError</code>接口。</p>
<p>　　Publisher在条件满足（有需求且有更多的消息）的情况下调用<code>onNext</code>向Subscriber发送消息。</p>
<p>　　如果Publisher已经结束产生更多消息，会调用<code>onComplete</code>通知Subscriber。</p>
<p>　　如果生成消息的stream出了问题无法恢复，也会调用<code>onError</code>通知Sbuscriber。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription subscription)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T element)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Subscription">Subscription</h3><p>　　Subscription描述一个Subscriber对一个Publisher的注册，注册成功后才可以通过这个Subscription的<code>requestMore</code>接口向Producer索取更多消息。</p>
<p>　　可以通过<code>cancel</code>接口取消掉这个subscription，取消时即使Publisher还有更多消息，也会停止向对应的Subscriber发送。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">Subscription</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestMore</span><span class="params">(<span class="keyword">int</span> elements)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Mampa里怎么做">Mampa里怎么做</h2><p>TO BE ADDED…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2014/08/26/backpressure/" data-id="ci7zkadyc004xr158zf78v58i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Reactive-Streams/">Reactive Streams</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/back-pressure/">back pressure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mampa/">mampa</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发/">并发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开源/">开源</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/异步/">异步</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-fetcher-mampa" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/08/05/fetcher-mampa/" class="article-date">
  <time datetime="2014-08-05T13:22:11.000Z" itemprop="datePublished">2014-08-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/08/05/fetcher-mampa/">mampa应用之——小米推送Fetcher服务性能调校</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://blog.xiaomi.com/wp-content/uploads/2014/03/mipush.jpg" alt=""></p>
<h3 id="背景">背景</h3><p>小米消息推送系统在前不久开始使用<a href="http://lyso.me/2014/02/01/mampa/" target="_blank" rel="external">MAMPA</a> 进行异步化改造，改造的过程中，发现对hbase的读写是关键路径，而这一步骤是同步操作，与mampa的异步化框架是相悖的，可优化空间并不大，调试很久后性能甚至尚未达到原同步版：要么线程数开少了竞争不过其它的非异步化实例，要么线程数开太多导致load太高，性能更差。</p>
<p>随后我们分析到hbase性能方面的问题后，参考<a href="https://www.usenix.org/system/files/conference/nsdi13/nsdi13-final170_update.pdf&amp;sa=U&amp;ei=gWJjU97pOeqxsQSDkYDAAg&amp;ved=0CBsQFjAA&amp;usg=AFQjCNGMeuWne9ywncbgux_XiZW6lQWHNw" target="_blank" rel="external">Scaling memcache at Facebook</a> <a href="http://qcontokyo.com/pdf/qcon_MarcKwiatkowski.pdf" target="_blank" rel="external">PPT</a> 设计了一套leased-cache，底层使用<a href="http://lyso.me/2014/03/10/redis-mampa/" target="_blank" rel="external">redis-mampa</a> （使用netty的异步化pipiline redis客户端）。</p>
<h3 id="初步试验">初步试验</h3><h4 id="实验环境：">实验环境：</h4><ul>
<li>hostA 作为压力测试客户端；</li>
<li>hostB 作为fetcher业务服务端；</li>
<li>hostC 作为redis、rabbitmq；</li>
<li>hostD 作为mysql；</li>
<li>Hbase访问采用mock数据并sleep一定时常方式；</li>
</ul>
<h4 id="实验环境：-1">实验环境：</h4><ul>
<li>HBase请求 sleep100ms左右；</li>
<li>Fetcher主逻辑线程6个、redis线程实验1/2/4/8个、hbase-mampa线程64个；</li>
</ul>
<h4 id="实验数据：">实验数据：</h4><ul>
<li>初始状态，cache里没有任何数据，请求全落到hbase：<ul>
<li>qps = 600，latency.99 =800ms</li>
</ul>
</li>
<li>以qps = 600将200w数据灌到redis中，模拟cache全命中情况：<ul>
<li>qps = 10000, latency.99 = 800ms，redis的latency.average在30ms左右</li>
<li>最大qps可以达到12000，此时查看数据生成导致mysql访问总是存在（mysql在主业务线程里访问，latency=0.5ms，6个线程qps峰值则为12000，后续可以通过mock 数据不需要访问mysql的情况来测试）</li>
</ul>
</li>
</ul>
<p>这里首先得到初步印象，latency的.99在800ms时，qps能达到10000，但没有获取到redis的latency.99以及这800ms的分布情况，而且有一个奇怪的现象是改变redis线程个数对结果影响不是太大，跟单独测试redis-mampa的性能情况不符。接下来进行更细致的实验和调校。</p>
<h3 id="实验调校">实验调校</h3><h4 id="步骤1：qps=5000">步骤1：qps=5000</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">6</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">5000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">wait~before~process.HIST-75-percentile</span>: <span class="string">86.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-95-percentile</span>: <span class="string">105.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-99-percentile</span>: <span class="string">118.71000000000004</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-999-percentile</span>: <span class="string">123.971</span></span><br><span class="line"></span><br><span class="line"><span class="stylus">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">73.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">115.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">142.71000000000004</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">191.942</span></span></span><br></pre></td></tr></table></figure>
<p>消息在系统中处理的总时间.99为142.71ms，latency是可以接受的，先看下这些时间的主要分布，之后增加qps后再放大地看是否存在问题：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">2.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">14.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">46.710000000000036</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">59.971000000000004</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">22.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">57.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">64.71000000000004</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">91.71000000000004</span></span><br><span class="line"></span><br><span class="line">(from tell是from send的超集，包括在actor的mailbox的时间）</span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">37.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">65.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">70.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">96.85500000000002</span></span><br></pre></td></tr></table></figure>
<h4 id="步骤2：qps=8000">步骤2：qps=8000</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">6</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">8000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">wait~before~process.HIST-75-percentile</span>: <span class="string">111.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-95-percentile</span>: <span class="string">142.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-99-percentile</span>: <span class="string">160.42000000000007</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-999-percentile</span>: <span class="string">164.971</span></span><br><span class="line"></span><br><span class="line"><span class="stylus">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">118.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">173.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">228.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">295.1880000000001</span></span></span><br></pre></td></tr></table></figure>
<p>消息在系统中处理的总时间.99为228ms，主要分布如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">4.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">26.549999999999955</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">74.97000000000025</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">99.0</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">49.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">165.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">196.71000000000004</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">207.0</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">81.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">174.54999999999995</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">204.42000000000007</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">210.0</span></span><br></pre></td></tr></table></figure>
<h4 id="步骤3：qps=10000">步骤3：qps=10000</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">6</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps =</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">131.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">227.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">463.5500000000002</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">499.884</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">2451.5</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">3307.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">3501.42</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">3581.980000000001</span></span><br></pre></td></tr></table></figure>
<p>消息在系统中处理的总时间.99飙升到3.5s，比之前初步实验时的情况还差，主要分布如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">43.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">330.2999999999997</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">699.0100000000011</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">1298.5780000000004</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">32.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">151.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">133294.30000000008</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">136519.942</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">57.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">310.3499999999983</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">133891.84</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">136521.681</span></span><br></pre></td></tr></table></figure>
<p>打到200w请求时，问题暴露出来了，这时发现内存飙升！<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="setting">load = <span class="value"><span class="number">5</span></span></span></span><br><span class="line"><span class="setting">mem=<span class="value"><span class="number">15</span>G</span></span></span><br></pre></td></tr></table></figure></p>
<h4 id="步骤4：分析内存异常">步骤4：分析内存异常</h4><p>重复实验几次后，大多数情况下都能重现内存暴涨的情况。于是通过 <a href="http://lyso.me/2014/07/01/bytebuf-memleak" target="_blank" rel="external">MAT分析java内存</a> 发现，redis-mampa内部的queue的size暴涨。这个queue是用来缓存pipiline发送到redis-server的命令以解析结果的发回给客户端的，当netty到redis-server这条通道的消息速度比客户端发来的慢时，就会导致queue堆积。</p>
<p>这就需要两个角度解决问题：</p>
<ol>
<li>需要对queue的size设置上限，在达到上限时降级服务，并打perf-counter</li>
<li>调查为何queue会堆积，因为qps没有达到实验性能</li>
</ol>
<h4 id="步骤5：queue-size限制">步骤5：queue-size限制</h4><p>加上 queue size 限制及perf：<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">6</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps =</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure></p>
<p>跑第一次时发现latency很小并且内存未涨，重复实验后又重现压力大的情况，但表现是：绝大多数请求因为redis超时和queue堆积而丢掉了（latency也很大）：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis~mampa~fail~<span class="built_in">queue</span>~<span class="literal">full</span><span class="built_in">.</span>COUNTER<span class="subst">=</span><span class="number">761222</span></span><br></pre></td></tr></table></figure></p>
<p>但查看redis-server的cpu/内存占用情况和机器load情况都无异常，猜测是由于主业务actor和redis-mampa的actor都是基于多优先级版disruptor的，用的SleepingWaitStrategy，这个等待策略先spin100次、再spin并yield100次、然后parkNanos，对CPU占用较大（由于是多优先级队列，不易使用BlockingWaitStrategy），于是将线程数改掉继续试验。</p>
<h4 id="步骤6：调整线程数">步骤6：调整线程数</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line"><span class="variable">qps =</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">133.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">167.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">175.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">196.942</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">131.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">201.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">249.71000000000004</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">260.913</span></span><br><span class="line"></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">5.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">29.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">55.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">114.59400000000005</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">58.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">109.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">156.71000000000004</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">171.971</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">67.75</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">116.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">167.1300000000001</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">172.0</span></span><br></pre></td></tr></table></figure>
<p>数据表示毫无压力，继续增加qps试试。</p>
<h4 id="步骤7：qps=12000">步骤7：qps=12000</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">12000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">144.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">166.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">181.71000000000004</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">195.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">128.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">214.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">296.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">316.942</span></span><br></pre></td></tr></table></figure>
<p>此时load=0.1，CPU=400%，latency.99在300ms，继续增加qps：</p>
<h4 id="步骤8：qps=15000">步骤8：qps=15000</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">15000</span></span><br></pre></td></tr></table></figure>
<p>在启动阶段load和CPU较高，latency也比较大，在打到60w-100w的时候latency降下来了：<br><code>mem=1.6G，CPU450%，load=3.0</code><br><code>rabbitmq.load=0.29, cpu=450%</code></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">wait~before~process.HIST-75-percentile</span>: <span class="string">186.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-95-percentile</span>: <span class="string">223.54999999999995</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-99-percentile</span>: <span class="string">235.0</span></span><br><span class="line"><span class="attribute">wait~before~process.HIST-999-percentile</span>: <span class="string">250.0</span></span><br><span class="line"></span><br><span class="line"><span class="stylus">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">140.75</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">239.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">369.84000000000015</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">408.797</span></span></span><br></pre></td></tr></table></figure>
<p>但是latency相对较高，每次请求有两次redis的cmget请求，qps=15000时redis请求为30000，4个线程的实验数据要比这个好的多，所以猜测这里还有猫腻，降低redis线程数继续试验：</p>
<h4 id="步骤9：比较不同redis线程数">步骤9：比较不同redis线程数</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">2</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">2</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">15000</span></span><br></pre></td></tr></table></figure>
<p>的情况是：</p>
<p><code>mem=1.9G，CPU450%，load=4.0</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">192.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">224.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">241.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">263.942</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">201.75</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">316.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">348.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">383.0</span></span><br></pre></td></tr></table></figure>
<p>而<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">2</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">15000</span></span><br></pre></td></tr></table></figure></p>
<p>的情况是：</p>
<p><code>mem=1.5G，CPU450%，load=0.3</code><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">183.0</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">216.54999999999995</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">378.1300000000001</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">416.65200000000004</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">90.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">160.54999999999995</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">241.42000000000007</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">312.942</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">53.75</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">198.54999999999995</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">250.84000000000015</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">266.971</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">69.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">198.0999999999999</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">262.5500000000002</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">270.0</span></span><br></pre></td></tr></table></figure></p>
<p>发现增加线程数的影响很小，进一步分析perf-counter，发现了redis的actor压力分布不均的情况，以下是redis线程分别是3、4、5的情况：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mampa~tell~actor~RedisMampa~<span class="number">0</span>/<span class="number">3</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">743969</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">1</span>/<span class="number">3</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">2833514</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">2</span>/<span class="number">3</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">743539</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mampa~tell~actor~RedisMampa~<span class="number">0</span>/<span class="number">4</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">155403</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">1</span>/<span class="number">4</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">156336</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">2</span>/<span class="number">4</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">155332</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">3</span>/<span class="number">4</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">758472</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mampa~tell~actor~RedisMampa~<span class="number">0</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">620549</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">1</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">3686638</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">2</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">620688</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">3</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">620500</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">4</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">620516</span></span><br></pre></td></tr></table></figure>
<p>分析发现数字很有规律，总是有一个actor上落的比较多，其他的比较平均，多的数量是少的数量的(actor个数+1)倍，以上表5个actor为例，可以这样认为，有两种请求，第一种请求平均分给了5个actor，每个62w，第二种请求全落在actor-1上了，共306w，则actor-1上有368w个。然后意识到一种key是带userid的，另一种是appid的，这里测试app只有一个，所以落在了一个actor上。解决方案是，提供可配置的<code>random-actor</code>方式路由到不同的actor，继续试验。</p>
<h4 id="步骤10：配置redis-mampa使用random-actor路由消息">步骤10：配置redis-mampa使用random-actor路由消息</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">2</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">5</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">20000</span></span><br></pre></td></tr></table></figure>
<p>实验结果中redis的actor分布较均匀了。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mampa~tell~actor~RedisMampa~<span class="number">0</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">908895</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">1</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">907672</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">2</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">910176</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">3</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">910250</span></span><br><span class="line">mampa~tell~actor~RedisMampa~<span class="number">4</span>/<span class="number">5</span><span class="class">.P0</span><span class="class">.COUNTER</span>=<span class="number">909681</span></span><br></pre></td></tr></table></figure>
<p>此时的latency为：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">21866.25</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">25688.65</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">26831.920000000002</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">27347.855</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">43.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">106.54999999999995</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">190.20000000000027</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">239.913</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">5.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">23.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">80.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">115.50700000000006</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">7.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">27.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">75.71000000000004</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">121.94200000000001</span></span><br><span class="line"></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">13.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">224.64999999999986</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">291.4200000000001</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">440.6220000000003</span></span><br></pre></td></tr></table></figure>
<p>可见redis的请求latency已经落回到合理的范围，但<code>wait~before~process</code>的时间很长，而且观察rabbitmq的状态发现fetcher模块整体produce的速度只有18000，而fetcher业务模块的disruptor占用情况为：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mailbox~occupied~size~Fetcher~<span class="number">0</span><span class="class">.p1</span><span class="class">.GAUGE</span>=<span class="number">465</span></span><br><span class="line">mailbox~occupied~size~Fetcher~<span class="number">0</span><span class="class">.p2</span><span class="class">.GAUGE</span>=<span class="number">1859</span></span><br><span class="line">mailbox~occupied~size~Fetcher~<span class="number">1</span><span class="class">.p1</span><span class="class">.GAUGE</span>=<span class="number">533</span></span><br><span class="line">mailbox~occupied~size~Fetcher~<span class="number">1</span><span class="class">.p2</span><span class="class">.GAUGE</span>=<span class="number">1981</span></span><br></pre></td></tr></table></figure>
<p>因此猜测是main.thread成为了瓶颈，于是调整一下线程分配：</p>
<h4 id="步骤11：调整main/redis线程分配">步骤11：调整main/redis线程分配</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="variable">thread=</span><span class="number">3</span></span><br><span class="line">redis.<span class="variable">thread=</span><span class="number">4</span></span><br><span class="line"><span class="variable">qps=</span><span class="number">20000</span></span><br></pre></td></tr></table></figure>
<p>此时<code>load=9, cpu=700%</code>，fetcher模块整体produce的速度基本达到了20000。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">wait~before~process<span class="class">.HIST-75-percentile</span>: <span class="number">7854.75</span></span><br><span class="line">wait~before~process<span class="class">.HIST-95-percentile</span>: <span class="number">11740.599999999999</span></span><br><span class="line">wait~before~process<span class="class">.HIST-99-percentile</span>: <span class="number">16918.420000000013</span></span><br><span class="line">wait~before~process<span class="class">.HIST-999-percentile</span>: <span class="number">18196.202</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>: <span class="number">64.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>: <span class="number">126.64999999999986</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>: <span class="number">206.84000000000015</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>: <span class="number">249.79700000000003</span></span><br><span class="line"></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-75-percentile</span>: <span class="number">17.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-95-percentile</span>: <span class="number">255.54999999999995</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-99-percentile</span>: <span class="number">374.3900000000003</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span><span class="class">.HIST-999-percentile</span>: <span class="number">443.971</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-75-percentile</span>: <span class="number">8.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-95-percentile</span>: <span class="number">37.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-99-percentile</span>: <span class="number">47.0</span></span><br><span class="line">redis~mampa~from~send<span class="class">.HIST-999-percentile</span>: <span class="number">51.0</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-75-percentile</span>: <span class="number">13.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-95-percentile</span>: <span class="number">37.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-99-percentile</span>: <span class="number">50.0</span></span><br><span class="line">redis~mampa~from~tell<span class="class">.HIST-999-percentile</span>: <span class="number">51.971000000000004</span></span><br></pre></td></tr></table></figure>
<p>但<code>wait~before~process</code>时间仍然较长，一部分原因是启动时就有堆积的延迟导致的，另外还需继续跟进的方面有：</p>
<h3 id="后续工作">后续工作</h3><ol>
<li>rabbitmq的CPU占用一直在500%上下，这里是否是瓶颈</li>
<li>能在多优先级队列的disruptor中支持更多的wait策略是否能解决load高的问题</li>
</ol>
<h4 id="多优先级队列disruptor支持BlockingWaitStrategy">多优先级队列disruptor支持BlockingWaitStrategy</h4><p>实验验证这种策略发现性能是有一定折扣的，</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Blocking:</span>  Benchmark/Single <span class="string">Ellapsed:</span> <span class="number">3007.42</span>ms, <span class="string">QPS:</span> <span class="number">468862.87</span>. (producerCount=<span class="number">1</span>, ringSize=<span class="number">1024</span>, queries=<span class="number">10000000</span>). </span><br><span class="line"><span class="string">Blocking:</span>  Benchmark/Multi  <span class="string">Ellapsed:</span> <span class="number">6067.46</span>ms, <span class="string">QPS:</span> <span class="number">232398.09</span>. (priorities=[<span class="number">1000</span>, <span class="number">1000</span>], ringSize=<span class="number">1024</span>x2, queries=<span class="number">10000000</span>).</span><br><span class="line"><span class="string">Sleeping:</span>  Benchmark/Single <span class="string">Ellapsed:</span> <span class="number">1126.05</span>ms, <span class="string">QPS:</span> <span class="number">1252227.05</span>. (producerCount=<span class="number">1</span>, ringSize=<span class="number">1024</span>, queries=<span class="number">10000000</span>). </span><br><span class="line"><span class="string">Sleeping:</span>  Benchmark/Multi  <span class="string">Ellapsed:</span> <span class="number">1378.33</span>ms, <span class="string">QPS:</span> <span class="number">1023022.22</span>. (priorities=[<span class="number">1000</span>, <span class="number">1000</span>], ringSize=<span class="number">1024</span>x2, queries=<span class="number">10000000</span>).</span><br></pre></td></tr></table></figure>
<p>但我们肯定达不到20w+的qps，可以先不关心这个，试一下用BlockingWaitStrategy的Fetcher性能：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">load=</span><span class="number">5</span>, <span class="variable">mem=</span><span class="number">1.3</span>g, <span class="variable">CPU=</span><span class="number">700</span>%</span><br></pre></td></tr></table></figure>
<p>无请求时CPU由60%降到7%</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-75-percentile</span>=<span class="number">57.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-95-percentile</span>=<span class="number">80.0</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-99-percentile</span>=<span class="number">93.71000000000004</span></span><br><span class="line">Request<span class="class">.lifetime</span><span class="class">.HIST-999-percentile</span>=<span class="number">106.91300000000001</span></span><br><span class="line"></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span>.HIST-<span class="number">75</span>-percentile=<span class="number">13.0</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span>.HIST-<span class="number">95</span>-percentile=<span class="number">51.549999999999955</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span>.HIST-<span class="number">99</span>-percentile=<span class="number">94.42000000000007</span></span><br><span class="line">mampa~event~inqueue~<span class="tag">time</span>.HIST-<span class="number">999</span>-percentile=<span class="number">181.56500000000005</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis~mampa~from~send.HIST-<span class="number">75</span>-percentile=<span class="number">5.0</span></span><br><span class="line">redis~mampa~from~send.HIST-<span class="number">95</span>-percentile=<span class="number">11.0</span></span><br><span class="line">redis~mampa~from~send.HIST-<span class="number">99</span>-percentile=<span class="number">20.0</span></span><br><span class="line">redis~mampa~from~send.HIST-<span class="number">999</span>-percentile=<span class="number">24.91300000000001</span></span><br><span class="line"></span><br><span class="line">redis~mampa~from~tell.HIST-<span class="number">75</span>-percentile=<span class="number">7.0</span></span><br><span class="line">redis~mampa~from~tell.HIST-<span class="number">95</span>-percentile=<span class="number">16.0</span></span><br><span class="line">redis~mampa~from~tell.HIST-<span class="number">99</span>-percentile=<span class="number">26.710000000000036</span></span><br><span class="line">redis~mampa~from~tell.HIST-<span class="number">999</span>-percentile=<span class="number">44.76800000000003</span></span><br></pre></td></tr></table></figure>
<p>OK，latency.99降到了100ms。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2014/08/05/fetcher-mampa/" data-id="ci7zkadxt003gr1580jhz2wui" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mampa/">mampa</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内存泄露/">内存泄露</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/小米推送系统/">小米推送系统</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发/">并发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/异步/">异步</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-queue-threory-littles-law" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/07/26/queue-threory-littles-law/" class="article-date">
  <time datetime="2014-07-26T10:44:12.000Z" itemprop="datePublished">2014-07-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/07/26/queue-threory-littles-law/">排队理论及Little&#39;s Law</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://img01.e23.cn/2012/0729/20120729064952752.jpg" alt=""></p>
<h2 id="队列无处不在">队列无处不在</h2><p>　　最近一直在做异步编程框架方面的工作。异步化最重要的几个概念是，消息/事件、队列/缓冲区、线程池等，在实际应用中需要考虑到队列满等问题。其实队列无处不在，不止是在异步程序框架里。诶，等一等，同步程序哪来的队列？的确是没有“明显的”。如果你用线程池执行同步代码，你得有有锁或信号量或等待队列从池里取出线程。如果你很彪悍，每个请求都新建一个线程来处理，那当你的线程数超过CPU数时，线程得在队列里等OS调度，还徒增线程上下文切换和条件变量的开销。队列无处不在，拥抱队列吧！既然无法避免队列，就用心设计好队列，比如用上无锁队列。</p>
<p>　　现实生活中队列也是无处不在，比如宇宙中心五道口的枣糕王队列和最近刚出来的西少爷队列，五彩城的外婆家队列，小米的周二抢手机队列，每个小米员工身上都挂着一堆F码队列，北京车牌摇号是个巨大的队列，等等……</p>
<h2 id="什么是队列，什么是排队理论">什么是队列，什么是排队理论</h2><p>　　<em>queue</em>一词来自于拉丁语<em>cauda</em>，是“马尾巴”的意思。排队理论（Queueing theory）是研究排队（queues，或者waiting lines）的数学方法。拼写成 “queueing” 而不是”queuing”据说是因为学术界相关领域有个很牛叉的期刊叫“Queueing Systems”……</p>
<p>　　一个在丹麦哥本哈根电话交换局工作的工程师 Agner Krarup Erlang（哈哈，就是Erlang编程语言的出处之一，另一出处是<em>Er</em>icsson <em>Lang</em>uage），研究人们打电话的方式，发展出人们需要等待多久的公式，并于1909年出版了关于排队理论的第一篇论文，当时称为话务理论。他在热力学统计平衡理论的启发下，成功地建立了电话统计平衡模型，并由此得到一组递推状态方程，从而导出Erlang电话损失率公式。自20世纪初以来，电话系统的设计一直在应用这个公式。30年代苏联数学家А.Я.欣钦把处于统计平衡的电话呼叫流称为最简单流。瑞典数学家巴尔姆又引入有限后效流等概念和定义。他们用数学方法深入地分析了电话呼叫的本征特性，促进了排队论的研究。50年代初，美国数学家关于生灭过程的研究、英国数学家D.G.肯德尔提出嵌入马尔可夫链理论，以及对排队队型的分类方法，为排队论奠定了理论基础。在这以后，L.塔卡奇等人又将组合方法引进排队论，使它更能适应各种类型的排队问题。70年代以来，人们开始研究排队网络和复杂排队问题的渐近解等，成为研究现代排队论的新趋势。</p>
<h2 id="队列的形成">队列的形成</h2><p>　　队列的形成是由于服务对象到达时间快于服务时间导致的。看这两种极端情况：</p>
<ul>
<li>服务时间为1秒/个，到达时间为2秒/个，永远不会产生队列堆积</li>
<li>服务时间为2秒/个，到达时间为1秒/个，队列会永无止境的增加</li>
</ul>
<p>　　而在现实服务系统中，服务时间和到达时间都是不是恒定的。如果一个队列不会随时间增加而无限增长，那么可以说它是<em>稳定</em>的。而对于单服务节点队列来说，如果其<em>平均服务时间</em>小于<em>平均到达时间</em>（或<em>平均服务速率</em>大于<em>平均到达速率</em>），则可以说它是稳定的。</p>
<p>　　例如下图，横坐标为时间，纵坐标为队列长度，这是一个稳定的队列，我们能看到“忙”与“闲”的交替，<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">　|</span><br><span class="line">队|                                   __</span><br><span class="line">列|        <span class="strong">__                      __</span>|  |__</span><br><span class="line">长|     <span class="strong">__|  |__</span>          <span class="strong">__    __</span>|        |</span><br><span class="line">度|  <span class="strong">__|        |__</span>    <span class="strong">__|  |__</span>|           |<span class="emphasis">___</span>_</span><br><span class="line">　|<span class="emphasis">_|_</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">___|__</span>|<span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span>|<span class="strong">_____</span>_</span><br><span class="line">　　　　时间</span><br></pre></td></tr></table></figure></p>
<p>　　而下图则是一个不稳定的队列，就像在高速路上发生车祸后的结果一样：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">　|                          <span class="emphasis">___</span>_| </span><br><span class="line">　|                       __|        </span><br><span class="line">　|                    __|            </span><br><span class="line">队|                 __|               </span><br><span class="line">列|        <span class="strong">__    __</span>|               </span><br><span class="line">长|     <span class="strong">__|  |__</span>|</span><br><span class="line">度|  __|        </span><br><span class="line">　|<span class="emphasis">_|_</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="strong">_____</span><span class="emphasis">___</span>_</span><br><span class="line">　　　　时间</span><br></pre></td></tr></table></figure></p>
<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>

<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

<h2 id="基本模型">基本模型</h2><p>　　排队系统又称服务系统。服务系统由服务系统和服务对象（顾客）构成。服务对象到来的时刻和对他服务的时间（即占用服务系统的时间）都是随机的。最简单的排队系统模型包括三个组成部分：输入过程、排队策略和服务系统。</p>
<h3 id="输入过程">输入过程</h3><p>　　输入过程考察的是顾客到达服务系统的规律。它可以用一定时间内顾客到达数或前后两个顾客相继到达的间隔时间来描述，一般分为确定型和随机型两种。例如，在生产线上加工的零件按规定的间隔时间依次到达加工地点，定期运行的班车、班机等都属于确定型输入。随机型的输入是指在时间 $t$ 内顾客到达数 $n(t)$ 服从一定的随机分布。如服从泊松分布，则在时间 $t$ 内到达$n$个顾客的概率为<br>$$<br>P_n(t)=\frac{e^{-\lambda t}{(\lambda t)}^n}{n!} (n=0,1,2,…,N)<br>$$<br>　　或相继到达的顾客的间隔时间 $T$ 服从负指数分布，即<br>$$<br>P(T \leqslant t)=1-e^{-\lambda t}<br>$$<br>　　式中 $\lambda$ 为单位时间顾客期望到达数，称为平均到达速率； $1/\lambda$ 为平均间隔时间。在排队论中，讨论的输入过程主要是随机型的。</p>
<h3 id="排队策略">排队策略</h3><p>　　排队策略分为等待策略、丢弃策略和混合策略三种。当顾客到达时，所有服务系统都被占用，则顾客排队等候，即为等待策略。在等待策略中，为顾客进行服务的次序可以是先到先服务，或后到先服务，或是随机服务和有优先权服务（如医院接待急救病人）。如果顾客来到后看到服务系统没有空闲立即离去，则为丢弃策略。有些系统因留给顾客排队等待的空间有限，因此超过所能容纳人数的顾客必须离开系统，这种排队策略就是混合策略。</p>
<h3 id="服务系统">服务系统</h3><p>　　可以是一个或多个服务节点。多个服务节点可以是平行排列的，也可以是串连排列的。服务时间一般也分成确定型和随机型两种。例如，自动冲洗汽车的装置对每辆汽车冲洗（服务）时间是相同的，因而是确定型的。而随机型服务时间 $v$ 则服从一定的随机分布。如果服从负指数分布，则其分布函数是<br>$$<br>P(v \leqslant t) = 1 - e^{-\mu t}    (t \geqslant 0)<br>$$<br>　　式中 $\mu$ 为平均服务率， $1/\mu$ 为平均服务时间。</p>
<h3 id="表示法">表示法</h3><p>　　一般使用David G. Kendall表示法，A/S/C：</p>
<ul>
<li>A（Arrival Process）：描述顾客到达系统的概率密度分布（在消息系统中对应于消息到达的概率分布）</li>
<li>S（Service Process）：描述顾客服务耗时的概率密度分布（在消息系统对应于消息处理的时间分布）</li>
<li>C（Number of Servers）：描述系统中的服务节点个数</li>
</ul>
<p>　　其中，A、S可以是以下任意一个：</p>
<ul>
<li>M (Markov)：Exponential probability density</li>
<li>D (Deterministic)：All customers have the same value</li>
<li>G (General)：Any arbitrary probability distribution</li>
</ul>
<h2 id="示例排队系统">示例排队系统</h2><p>　　例如有以下类型的排队系统：</p>
<h3 id="M/M/1">M/M/1</h3><ul>
<li>最简单的排队系统，一个服务节点</li>
<li>到达时间负指数分布（泊松过程）</li>
<li>服务时间负指数分布（泊松过程）</li>
<li>服务策略：FIFS（先入队先服务）</li>
</ul>
<h4 id="泊松过程（Poisson_process）">泊松过程（Poisson process）</h4><p>　　泊松过程以法国数学家泊松命名，是随机过程的一种。M/M/1系统假设到达时间符合泊松分布，在现实系统中需要满足以下三点才可以做此近似假设：</p>
<ul>
<li>无限请求数，或请求数量很大</li>
<li>单次请求对系统性能和资源占用都很小</li>
<li>所有请求之间相互独立，互不影响/依赖<br>　　例如公路系统中的车辆，就满足：</li>
<li>车辆数非常多</li>
<li>每辆车占用公路上的位置很小</li>
<li>所有的车决定走哪条路、怎么走，对其他车辆影响不大<br>　　如果公路上正在举行公路赛，那么条件2、3就不满足了，就不能用泊松过程近似。</li>
</ul>
<p>　　$n$个请求在时间$0$ ~ $t$内到达的泊松过程的概率密度分布可以表示如下：<br>$$<br>P_n(t)=\frac{(\lambda t)^n}{n!}e^{-\lambda t}<br>$$<br>　　其中，</p>
<ul>
<li>$t$是历经时间</li>
<li>$n$是这段时间请求到达总数</li>
<li>$\lambda$是平均到达速率</li>
</ul>
<h4 id="负指数分布">负指数分布</h4><p>　　如果泊松概率分布不够直观，可以将其简化：在一段时间内没有任何请求到达的分布，也就是泊松分布中的$n=0$：<br>$$<br>P_0(t)=e^{-\lambda t}<br>$$<br>　　还拿高速公路举例子，一段路上平均每10s有1个车到达（到达速率为0.1 车/秒）。下图是随时间t没有一个车到达的概率分布。<br><img src="http://www.eventhelix.com/realtimemantra/congestioncontrol/images/poisson.gif" alt=""><br>　　可见，一段时间内看不到一辆车的概率会碎观察时间间隔的增长而急剧下降：１秒内是90%，20秒内只有10%了。</p>
<h4 id="M/M/1系统的结果分析">M/M/1系统的结果分析</h4><p>　　对于稳定的系统，服务速率要大于到达速率。定义“流量强度”$\rho$如下：<br>$$<br>\rho = \lambda / \mu<br>$$<br>　　其中$\lambda$为到达速率，$\mu$为服务速率。也就是稳定系统的$rho&lt;1$。则系统中的平均请求数$N$为：<br>$$<br>N = \frac{\rho}{1-\rho}<br>$$<br>　　容易看出，当$rho$趋近于1时$N$急速增大。从这个式子可以简单推导出总的等待时间（包括服务时间）（见后文Little’s Law）：<br>$$<br>T = \frac{1}{\mu - \lambda}<br>$$</p>
<h3 id="M/D/1，M/D/n系统">M/D/1，M/D/n系统</h3><p>Agner Krarup Erlang在1917建模并解决了M/D/1系统，随后在1920年建模了M/D/n系统：</p>
<ul>
<li>M stands for Markov or memoryless and means arrivals occur according to a Poisson process</li>
<li>D stands for deterministic and means jobs arriving at the queue require a fixed amount of service</li>
<li>n describes the number of servers at the queueing node (k = 1, 2,…).</li>
</ul>
<h3 id="M/G/1，_M/G/n系统">M/G/1， M/G/n系统</h3><p>M/G/1系统由Felix Pollaczek在1930年解决。而M/G/n系统的性能分析仍然是一个<a href="http://en.wikipedia.org/wiki/M/G/k_queue" target="_blank" rel="external">开放问题</a>。</p>
<h3 id="G/G/n系统">G/G/n系统</h3><p>This is the most general queueing system where the arrival and service time processes are both arbitrary. The system has n servers. No analytical solution is known for this queueing system.</p>
<h2 id="测量指标">测量指标</h2><ul>
<li>平均等待时间、等待时间.99/.95/.75</li>
<li>服务节点利用率<ul>
<li>比如，消息到达速率为10ms一个，平均每个处理时间为8ms，则服务节点可用率为 $P=(1 / 10) * 8 = 80% $</li>
</ul>
</li>
<li>吞吐/QPS</li>
<li>平均等待消息个数</li>
<li>消息等待个数分布（例如 $P(n), n=0, 1, 2…$表示有n个消息在等待的概率）</li>
</ul>
<h2 id="Little’s_Law">Little’s Law</h2><p>　　一般译为利特尔法则，指在一个稳定的系统（排队理论中的系统）中，长时间观察到的平均顾客数量$L$，等于长时间观察到的有效到达速率$\lambda$与平均每个顾客在系统中花费的时间之乘积，即<br>$$<br>L = \lambda W<br>$$<br>　　由麻省理工大学斯隆商学院（MIT Sloan School of Management）的教授John Little于1961年所提出与证明。这一法则为精益生产的改善方向指明了道路。如何有效地缩短生产周期呢？利特尔法则已经很明显地指出了方向。一个方向是提高产能，从而降低生产节拍；另一个方向就是压缩存货数量。然而，提高往往意味着增加很大的投入。另外，生产能力的提升虽然可以缩短生产周期，但是，生产能力的提升总有个限度，我们无法容忍生产能力远远超过市场的需求。一般来说，每个公司在一定时期内的生产能力是大致不变的，而从长期来看，各公司也会力图使自己公司的产能与市场需求相吻合。因此，最有效地缩短生产周期的方法就是压缩在制品数量。<br>　　利特尔法则不仅适用于整个系统，而且也适用于系统的任何一部分。</p>
<p>　　平均顾客数量$L=\lambda/(\mu-\lambda)$，则平均等待时间（排队时间+服务时间）可以计算为：<br>$$<br>W=1/(\mu - \lambda)<br>$$<br>　　平均等待时间为：<br>$$<br>W_q = 1 /(\mu − \lambda) − 1/\mu = \lambda /\mu( \mu − \lambda)<br>$$</p>
<h2 id="有什么用？">有什么用？</h2><p>　　可以根据Little’s Law设计系统中的队列长度——压缩在制品数量，比如Mampa的mailbox长度设计。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2014/07/26/queue-threory-littles-law/" data-id="ci7zkadx3001sr158h1g77p8k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/little-s-law/">little's law</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/queueing-threory/">queueing threory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/利特尔法则/">利特尔法则</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发/">并发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/异步/">异步</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/排队理论/">排队理论</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/泊松过程/">泊松过程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/负指数分布/">负指数分布</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/马尔科夫链/">马尔科夫链</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-who-am-i" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/07/10/who-am-i/" class="article-date">
  <time datetime="2014-07-10T14:11:40.000Z" itemprop="datePublished">2014-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/07/10/who-am-i/">我是谁</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="名片">名片</h2><ul>
<li><em>Lyso什么意思？</em> 小时候给自己起网名，本来就想叫ly的，发现要么是闲俩字太短，要么是ly被占用了。于是我就开始分析自己的名字，有三氧化硫之拆解义，故而拼凑上一个so3，于是lyso3就成了网名。但后来疑问也有了，lyso是谁？lyso1和lyso2呢？就干脆叫lyso吧。有朋友发音[li:seu]，正确发音是[laiseu]，同“来搜”。</li>
<li><em>性别</em> 男</li>
<li><em>Email/gtalk</em> leoyonn@gmail.com</li>
<li><em>微信</em> leoyonn <em>可以扫名片里的二维码</em></li>
<li><em>米聊</em> 2481178 <em>可以扫名片里的二维码</em></li>
<li><em>linkedin</em> <a href="https://www.linkedin.com/in/leoyonn" target="_blank" rel="external">https://www.linkedin.com/in/leoyonn</a></li>
<li><em>github</em> <a href="https://github.com/leoyonn" target="_blank" rel="external">https://github.com/leoyonn</a><br><img src="http://lyso.qiniudn.com/leo-vcard-c.png" width="300px"></li>
</ul>
<h2 id="私塾混迹">私塾混迹</h2><ul>
<li>2004.09 ~ 2008.07 北京大学 计算机科学与技术系 本科</li>
<li>2008.09 ~ 2011.07 北京大学 计算机科学与技术系 硕士</li>
</ul>
<h2 id="涉世之初">涉世之初</h2><ul>
<li>2009.02 ~ 2009.06 北京大学信息科学技术学院研会宣传部部长</li>
<li>2006.09 ~ 2007.07 北京大学计算机协会人事部部长</li>
<li>2006.01 ~ 2006.07 北京大学学生服务总队爱心电脑小组组长</li>
</ul>
<h2 id="江湖足迹">江湖足迹</h2><ul>
<li>2007.09 ~ 2007.11 | <em>北京普科新天科技有限公司</em> 兼职</li>
<li>2007.12 ~ 2008.04 | <em>Miparvo Technologies, Inc公司</em> 项目合作</li>
<li>2009.03 ~ 2010.03 | <em>微软亚洲研究院（MSRA）</em> 项目合作</li>
<li>2010.04 ~ 2010.04 | <em>腾讯无线事业部</em> 实习（20天）</li>
<li>2010.07 ~ 2010.09 | <em>百度搜索研发部</em> 实习</li>
<li>2011.03 ~ 2013.04 | <em>网易有道</em> 第一份正式工作</li>
<li>2012.05 ~ 2012.08 | <em>迅知科技</em> 合伙创业</li>
<li>2013.04 ~ 今 | <em>小米科技</em> 第二份正式工作</li>
</ul>
<h2 id="打怪升级">打怪升级</h2><h3 id="2013-04_~_目前_|_小米科技">2013.04 ~ 目前 | <em>小米科技</em></h3><ul>
<li><em>小米推送系统</em><ul>
<li>同时在线用户数<em>70,000,000</em>+，日活跃用户数<em>100,000,000</em>+，日发消息量<em>600,000,000</em>+</li>
<li>架构设计及研发主力(初期 2 R&amp;D之一)，包括设计与开发：接口层(HTTP/长连接)、业务逻辑层、存储层(cache/mysql/hbase等schema设计及client端优化)、统计监控及辅助工具等</li>
<li>基于kafka/zookeeper等集群设计实现高吞吐公平性多优先级及流控模块，作为系统中消息发送的核心节点</li>
</ul>
</li>
<li><em>小米开放消息系统</em><ul>
<li>底层架构的设计及开发、接口及业务逻辑层的设计及部分开发、存储层的schema设计</li>
<li>项目驱动(组织讨论分工、组织推动CodeReview/集成测试/每日构建/压力测试，上线进程规范化及推动)</li>
</ul>
</li>
<li><em>基础框架及工具</em><ul>
<li><em>MAMPA</em>：<ul>
<li>小米异步消息处理架构(xiaoMi Asynchronous Message Processing Architecture)</li>
<li>吸取Erlang/Akka等异步并发语言/框架之精化，使用disruptor/自管理线程池等方法，用Actor/ActorGroup/ FSM/ RuleSet等概念将线程安全等问题隐藏，对高吞吐并发服务的开发效率及性能都有较大提升</li>
<li>用自实现非线程安全对象池、预开辟连续空间等方法进一步优化内存使用，尽可能的避免了GC等问题</li>
<li>小米开放消息系统所有服务底层架构、一些异步存储等客户端(redis/hbase/kafka/tracer等)底层架构、小米云平台各底层消息框架正在逐步迁移到此架构上(推送/米信/米聊/米云等，吞吐远高于原架构)</li>
</ul>
</li>
<li><em>Redis-Mampa</em>：<ul>
<li>基于MAMPA的异步redis客户端，与redis-server通过netty4.x用pipeline通信，性能远高于Jedis等客户端</li>
<li>进一步封装成Cache层，可以自定义配置key、value的编解码，简化使用者的工作</li>
</ul>
</li>
<li><em>HBase-Mampa</em>：<ul>
<li>基于MAMPA的异步HBase客户端，对HBase的访问进行了如batch化、多线程化等极致的优化，巧妙避开了hbase-server对batch中的key写请求乱序执行等问题，并基于MAMPA的异步模式提供更丰富的接口类型</li>
</ul>
</li>
<li><em>Xsupervisor</em>：<ul>
<li>根据自定义配置监管多种服务(如redis/twemproxy等)，在推小米推送系统等服务中连续数月稳定运行</li>
<li>提供将监管服务自动注册到zookeeper、根据心跳及时重启宕掉的服务、状态监控及控制终端等功能</li>
</ul>
</li>
<li><em>Jerrymice</em>：<ul>
<li>基于jetty开发的极轻量级restful/web框架，可独立运行或内嵌于其他服务中，用法极简</li>
<li>支持jsp/html等页面渲染及json/xml/plaintext等多种返回方式</li>
<li>支持将任意数据类型通过Model参数送至页面、支持url正则式、支持参数变量化</li>
<li>广泛应用于推送系统/开放消息系统等服务的问题追查/服务状态监控/压力测试/辅助工具等</li>
</ul>
</li>
<li><em>Async-scribe-client</em>：<ul>
<li>用disruptor及一系列优化封装的scribe客户端，将log收集的QPS提升60+倍，应用于第一代Tracer等处</li>
</ul>
</li>
<li><em>Deployer</em>：<ul>
<li>服务一键部署：可将任意子模块部署到不同环境(开发机/测试机/沙箱/线上)的任意机器上</li>
<li>环境一键部署：可将Kafka集群、Redis/Twemproxy集群等轻松部署到不同的环境</li>
</ul>
</li>
<li><em>Tracer</em>：<ul>
<li>为业务系统中用来追踪消息、调查问题开发的框架</li>
<li>展示端使用Jerrymice，收集端第一代使用优化后的scribe、第二代使用kafka+MAMPA+hbase</li>
</ul>
</li>
<li><em>Xmpush/OMS-Console</em>：<ul>
<li>Jerrymice开发，查看服务/机器状态/PerfCounter、查询配置及数据、向服务发送控制命令等辅助工具集</li>
</ul>
</li>
<li><em>Oms-benchmark</em>：<ul>
<li>Jerrymice开发，将所有不同业务模块benchmark及压力测试的工作简化到只需要在页面上点几下按钮</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2011-03_~_2013-04_|_网易有道">2011.03 ~ 2013.04 | <em>网易有道</em></h3><ul>
<li>2012.11 ~ 2013.04 | luna.bisheng组·毕昇资料库项目<ul>
<li>毕昇资料库系统总体设计（包括收集层、存储层、构建层、服务层）</li>
<li>数据定义、构建层、存储层的详细设计与实现</li>
</ul>
</li>
<li>2011.10 ~ 2013.04 | discovery组·网易饭饭项目<ul>
<li>个性化餐馆推荐系统的设计、实现与优化</li>
<li>推荐算法评估方法及流程的设计与实现（自动质量测试流程及功能 / 质量 / 性能评估流程）</li>
<li>服务器端部分接口层、逻辑层及存储系统(包括持久化与缓存系统)的设计与研发</li>
<li>设计及实现“以图识菜”项目（提取图像特征、训练模型并进行菜品分类推测）</li>
<li>组织组内和公司范围的推荐算法及相关技术交流，多次分享相关知识与经验</li>
</ul>
</li>
<li>2011.03 ~ 2012.11 | mobile组·网易八方项目<ul>
<li>网易八方1.8版、2.0版服务器端90%以上的功能开发</li>
<li>自主设计与研发网易八方照片滤镜功能，并大范围分享算法技术和代码</li>
<li>网易八方后台技术组的负责人（2011.09之后），负责项目开发进度、上线以及对运维、运营的技术支持</li>
</ul>
</li>
</ul>
<h3 id="2011-BC_踏足江湖之前">2011.BC 踏足江湖之前</h3><ul>
<li><p>2010.11 ~ 2011.06 | 网格表面并行蓝噪声采样·毕业设计项目</p>
<ul>
<li>创新地结合图论理论与GPU并行计算特征，解决了非均匀网格表面采样并行化问题，极大提高了采样速度</li>
</ul>
</li>
<li><p>2010.07 ~ 2010.09 | 百度搜索研发部（spider）·实习生项目</p>
<ul>
<li>搜索引擎爬虫行为分析，UserAgent抓取对比实验及DNS解析服务器的设计与编码实现</li>
</ul>
</li>
<li><p>2009.03 ~ 2010.03 | LIBRS基于图像的立体绘制系统·公司合作项目</p>
<ul>
<li><em>微软亚洲研究院（MSRA）eHeritage文化遗产数字化研究</em> 的子项目</li>
<li>设计与实现多线程控制双目立体绘制并行流水线，创新地使用多级循环生产者-消费者模式</li>
<li>前后使用cg / CUDA对原算法进行多种基于并行的优化，加速比达到8,000（40FPS x 2 vs. 0.5FPM）</li>
<li>发会议Siggraph Asia 2010（Jie Feng, Yang Liu and Bingfeng Zhou. Real-time Stereo Visual Hull Rendering Using a Multi-GPU-accelerated Pipeline. SIGGRAPH Asia 2010, technical sketch, Seoul, Korea, Article 52, 2010.）</li>
</ul>
</li>
<li><p>2009.03 ~ 2009.05 | 基于内容的图像检索系统·课程项目</p>
<ul>
<li>负责项目规划、系统设计、结果分析、系统整合；负责系统界面与模块接口设计与实现；</li>
<li>负责4种/ 7种图像特征提取的调研与实现；分类准确率达近70%</li>
</ul>
</li>
<li><p>2007.12 ~ 2008.04 | 基于网页的协作地图绘制平台 | <em>Miparvo Technologies, Inc公司</em> 合作项目</p>
<ul>
<li>调研、设计、开发了系统的客户端；使用Silverlight、Microsoft VE SDK、YUI、JavaScript编程</li>
<li>实现了强大的图形绘制、图形修改功能，以及上传下载绘图数据的功能</li>
<li>设计并实现了优秀的用户界面（前后经过3次大改进，甲方负责人非常满意）</li>
</ul>
</li>
<li><p>2007.09 ~ 2007.11 | <em>北京普科新天科技有限公司</em> 兼职实习项目</p>
<ul>
<li>设计和实现了陆地边防视频监控系统客户端控制部分（包括部分界面功能的实现）</li>
</ul>
</li>
</ul>
<h2 id="经验值">经验值</h2><ul>
<li><em>语言</em>：<em>Java、Golang、Erlang、Python、C/C++、CUDA/cg/OpenGL</em></li>
<li><em>并发</em>：Java多线程模型/内存模型及优化、同构/异构并行计算(CPU/GPU)</li>
<li><em>Netty</em>：与前端机器的长连接维持、Redis-MAMPA中与redis/tewmproxy集群服务端的消息传输</li>
<li><em>Disruptor</em>：MAMPA中Actor的mailbox以及其他异步框架中的队列(如async-scribe-client等)</li>
<li><em>Kafka</em>：搭建kafka机群提供推送系统、开放消息系统所有业务的消息中转传输</li>
<li><em>Redis/Twemproxy</em>：修改redis-server源代码(v2.8.7+)，如提供更丰富的过期操作(getex/setex/lrangeex)等</li>
<li><em>HBase</em>：多种业务主要的底层存储，和infra的同事(小米有2个HBase Commiter)一起根据业务类型不同设计schema、优化client以达到更好的读写性能</li>
<li><em>Thrift</em>：用thrift服务提供消息序列化/反序列化、服务注册及查找等功能</li>
<li><em>Scribe</em>：服务集群中多模块的log收集汇总、消息追踪</li>
<li><em>Zookeeper</em>：用以进行配置等信息的统一化管理</li>
<li><em>Phabricator</em>：推动组内同事对phabricator等工具的使用，推动项目代码规范化(如maven规范等)</li>
</ul>
<h2 id="取之江湖，还之江湖">取之江湖，还之江湖</h2><ul>
<li>在学校时对自学的东西做过一些小范围内的讲座</li>
<li>参与一些公益志愿者活动</li>
<li>根据项目需求便利撰写些电子书共享出来，比如 <a href="http://download.csdn.net/detail/lyso1/1999537" target="_blank" rel="external">独立游戏开发指南之开源免费游戏引擎篇</a></li>
<li>组织公司内技术分享，并提供给母公司其他部门</li>
<li>开源项目及公共基础框架开发（参见前述）</li>
<li>本博客</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2014/07/10/who-am-i/" data-id="ci7zkadwf000cr15801e3omho" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-bytebuf-memleak" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/07/01/bytebuf-memleak/" class="article-date">
  <time datetime="2014-07-01T13:22:11.000Z" itemprop="datePublished">2014-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/07/01/bytebuf-memleak/">追查线上问题之——ByteBuf内存泄露</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://content.xilu.com/uploadfile/2011/0815/20110815094715719.jpg" alt="leak"></p>
<p>　　最近新上线的异步化服务，查看perf-counter完全没有达到理论的QPS，于是开始在线下模拟线上情况做实验，结果总是符合理论推算，无法重现线上的情况，甚至一度怀疑是hbase服务集群扛不住压力导致的。在无计可施时，在亮老师和欧老师的指点下，开启了这段分析之旅，这里做个记录，方便有遇到类似问题的童鞋们有个参照。</p>
<h3 id="看进程的情况：top">看进程的情况：top</h3><p><code>[leo@online:~]# top</code></p>
<p>top命令查看这个线程的情况，发现内存占用量很大：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Tasks</span>: <span class="string">254 total,   1 running, 232 sleeping,   0 stopped,  21 zombie</span></span><br><span class="line"><span class="attribute">Cpu(s)</span>: <span class="string">22.7%us,  5.3%sy,  0.0%ni, 71.8%id,  0.0%wa,  0.0%hi,  0.3%si,  0.0%st</span></span><br><span class="line"><span class="attribute">Mem</span>: <span class="string"> 32850724k total, 31968708k used,   882016k free,    88052k buffers</span></span><br><span class="line"><span class="attribute">Swap</span>: <span class="string">12582904k total,   953140k used, 11629764k free, 14371656k cached</span></span><br><span class="line"></span><br><span class="line"><span class="r">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND</span><br><span class="line"><span class="number">13205</span> root      <span class="number">20</span>   <span class="number">0</span> 8120m <span class="number">3.</span>3g  18m S <span class="number">120.7</span> <span class="number">10.7</span>   <span class="number">5890</span>:<span class="number">33</span> java -XX:<span class="keyword">...</span></span><br><span class="line"> <span class="number">5591</span> root      <span class="number">20</span>   <span class="number">0</span> 8835m <span class="number">2.</span>3g <span class="number">9996</span> S <span class="number">33.6</span>  <span class="number">7.5</span>   <span class="number">3491</span>:<span class="number">29</span> java -XX:<span class="keyword">...</span></span></span><br></pre></td></tr></table></figure>
<h3 id="看gc情况：jstat">看gc情况：jstat</h3><p><code>[leo@online:~]# jstat -gcutil 13205 100 10</code></p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">S0     S1     <span class="keyword">E</span>      <span class="keyword">O</span>      P     YGC     YGCT    FGC    FGCT     GCT   </span><br><span class="line"><span class="number">0.00</span> <span class="number">100.00</span> <span class="number">100.00</span>  <span class="number">99.98</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25876</span> <span class="number">24241.376</span> <span class="number">24954.239</span></span><br><span class="line"><span class="number">0.00</span> <span class="number">100.00</span> <span class="number">100.00</span>  <span class="number">99.98</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25876</span> <span class="number">24241.376</span> <span class="number">24954.239</span></span><br><span class="line"><span class="number">0.00</span> <span class="number">100.00</span> <span class="number">100.00</span>  <span class="number">99.98</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25876</span> <span class="number">24241.376</span> <span class="number">24954.239</span></span><br><span class="line"><span class="number">0.00</span>  <span class="number">97.03</span>  <span class="number">99.56</span>  <span class="number">99.94</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25876</span> <span class="number">24243.470</span> <span class="number">24956.333</span></span><br><span class="line"><span class="number">0.00</span> <span class="number">100.00</span> <span class="number">100.00</span>  <span class="number">99.98</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25877</span> <span class="number">24243.470</span> <span class="number">24956.333</span></span><br><span class="line"><span class="number">0.00</span> <span class="number">100.00</span> <span class="number">100.00</span>  <span class="number">99.98</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25877</span> <span class="number">24243.470</span> <span class="number">24956.333</span></span><br><span class="line"><span class="number">0.00</span> <span class="number">100.00</span> <span class="number">100.00</span>  <span class="number">99.98</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25877</span> <span class="number">24243.470</span> <span class="number">24956.333</span></span><br><span class="line"><span class="number">0.00</span> <span class="number">100.00</span> <span class="number">100.00</span>  <span class="number">99.98</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25877</span> <span class="number">24243.470</span> <span class="number">24956.333</span></span><br><span class="line"><span class="number">0.00</span> <span class="number">100.00</span> <span class="number">100.00</span>  <span class="number">99.98</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25877</span> <span class="number">24243.470</span> <span class="number">24956.333</span></span><br><span class="line"><span class="number">0.00</span> <span class="number">100.00</span> <span class="number">100.00</span>  <span class="number">99.98</span>  <span class="number">60.00</span>  <span class="number">33453</span>  <span class="number">712.862</span> <span class="number">25877</span> <span class="number">24243.470</span> <span class="number">24956.333</span></span><br></pre></td></tr></table></figure>
<p>　　不看不知道，一看吓一跳：Eden代、老生代全满了，频繁发生Full GC！  </p>
<h3 id="看进程内存占用情况：jmap">看进程内存占用情况：jmap</h3><p><code>[leo@online:~]# jmap -histo:live 13205 | less</code></p>
<figure class="highlight profile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   <span class="number">1</span>:         <span class="number">34943</span>     <span class="number">2675903544</span>  [B</span><br><span class="line">   <span class="number">2</span>:       <span class="number">3611235</span>      <span class="number">194315032</span>  [C</span><br><span class="line">   <span class="number">3</span>:       <span class="number">3622541</span>      <span class="number">115921312</span>  <span class="filename">java.lang.String</span><br><span class="line">   4</span>:       <span class="number">1037136</span>       <span class="number">29288720</span>  [J</span><br><span class="line">   <span class="number">5</span>:        <span class="number">979922</span>       <span class="number">23518128</span>  <span class="filename">java.util.BitSet</span><br><span class="line">   6</span>:        <span class="number">407110</span>       <span class="number">19541280</span>  <span class="filename">com.xiaomi.xmpush.thrift.Target</span><br><span class="line">   7</span>:         <span class="number">96961</span>       <span class="number">16289448</span>  <span class="filename">com.xiaomi.xmpush.thrift.XmPushServerContainer</span><br><span class="line">   8</span>:         <span class="number">70627</span>        <span class="number">9615944</span>  &lt;methodKlass&gt;</span><br><span class="line">   <span class="number">9</span>:         <span class="number">70627</span>        <span class="number">9534712</span>  &lt;constMethodKlass&gt;</span><br><span class="line">  <span class="number">10</span>:        <span class="number">158114</span>        <span class="number">8854384</span>  <span class="filename">com.xiaomi.xmpush.thrift.SubscribeTopicInfo</span><br><span class="line">  11</span>:        <span class="number">239540</span>        <span class="number">7665280</span>  <span class="filename">java.util.HashMap$Entry</span><br><span class="line">  12</span>:         <span class="number">76359</span>        <span class="number">6108720</span>  <span class="filename">com.xiaomi.xmpush.thrift.XmPushBroadcastTopic</span><br><span class="line">  13</span>:          <span class="number">5016</span>        <span class="number">6029160</span>  &lt;constantPoolKlass&gt;</span><br><span class="line">  <span class="number">14</span>:         <span class="number">89860</span>        <span class="number">5358112</span>  &lt;symbolKlass&gt;</span><br><span class="line">  <span class="number">15</span>:         <span class="number">80553</span>        <span class="number">5155392</span>  <span class="filename">com.xiaomi.xmpush.thrift.PushMetaInfo</span><br><span class="line">  16</span>:         <span class="number">69778</span>        <span class="number">5148672</span>  [<span class="filename">Ljava.lang.Object;</span><br><span class="line">  17</span>:         <span class="number">72151</span>        <span class="number">4617664</span>  <span class="filename">com.xiaomi.xmpush.thrift.PushRegistrationInfo</span><br><span class="line">  18</span>:         <span class="number">92951</span>        <span class="number">4461648</span>  <span class="filename">io.netty.util.HashedWheelTimer$HashedWheelTimeout</span><br><span class="line">  19</span>:          <span class="number">5016</span>        <span class="number">4450704</span>  &lt;instanceKlassKlass&gt;</span><br><span class="line">  <span class="number">20</span>:         <span class="number">96884</span>        <span class="number">3875360</span>  <span class="filename">com.xiaomi.xmpush.thrift.XmPushActionFetchMessage</span></span><br></pre></td></tr></table></figure>
<p>　　有34943个byte[]示例居然占去了2.5G的内存！得好好分析下这里出了什么问题。<span></span></p>
<h3 id="看进程内存详细占用情况：jmap">看进程内存详细占用情况：jmap</h3><p><code>[leo@online:~]# jmap -dump:format=b,file=/tmp/fetch.13205.bin 13205</code></p>
<p>　　将内存全部dump到本地文件（还是线上机器），然后压缩一下，传输到远程本地机器，并解压： </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[leo<span class="variable">@online</span><span class="symbol">:~</span>]<span class="comment"># tar cvzf /tmp/fetch.tar.gz /tmp/fetch.13205.bin</span></span><br><span class="line">[leo<span class="variable">@online</span><span class="symbol">:~</span>]<span class="comment"># scp /tmp/fetch.tar.gz leo<span class="yardoctag">@leohost</span>:/tmp</span></span><br><span class="line">[leo<span class="variable">@leohost</span><span class="symbol">:~</span>]<span class="comment"># tar -xvzf /tmp/fetch.tar.gz</span></span><br></pre></td></tr></table></figure>
<h3 id="分析内存：mat">分析内存：mat</h3><p>　　jhat和mat可以查看jmap的结果，jhat挺弱，用mat可以在eclipse安装插件，也可以在这里<a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="external">下载mat</a>  </p>
<h4 id="Overview">Overview</h4><p>　　在首页上点击【Open Dump File】，在【Overview】页发现4块大内存占去了绝大部分：<br><img src="http://lyso.qiniudn.com/memleak.4.png" alt="image">  </p>
<h4 id="Dominator_Tree">Dominator Tree</h4><p>　　在这里可以看得到，前四个是 <code>io.netty.buffer.PoolArena$HeapArena</code> 对象。难道我代码里哪里hold住了这么大的内存？印象中没有申请过啊，赶紧去看看吧。<br><img src="http://lyso.qiniudn.com/memleak.1.png" alt="image"> </p>
<h4 id="Reference_Tree">Reference Tree</h4><p>　　在任意一个对象上右击，【Path to GC Root】-&gt;【with all references】，可以看到下图，哈哈，找到了自己的代码（<code>com.xiaomi.mampa.redis.utils.Utils</code>）！<br><img src="http://lyso.qiniudn.com/memleak.3.png" alt="image"><br>　　这里有一段这样的代码：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteBufAllocator bufPool = <span class="keyword">new</span> PooledByteBufAllocator();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">ByteBuf <span class="title">allocByteBuf</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> bufPool.<span class="title">buffer</span><span class="params">(initialCapacity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　就是这里的问题了，异步pipeline的客户端Redis-Mampa中在序列化前使用ByteBuf对象暂存指令和参数，这个ByteBuf是基于引用计数的，需要用完之后release。后来跟长者陈述这个问题时，长者一拍大腿“哎呀你不早问我！用netty的东西都得自己申请和释放！”。早问你了我不会像这样记这么<strong><em>深刻</em></strong>^^。<span></span></p>
<h3 id="修复">修复</h3><p>　　很简单，用完就release呗：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Encode and write this command to the supplied buffer using the new</span><br><span class="line"> * &lt;a href="http://redis.io/topics/protocol"&gt;Unified Request Protocol&lt;/a&gt;.</span><br><span class="line"> *</span><br><span class="line"> * @param buf Buffer to write to.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="literal">void</span> encode(ByteBuf buf) &#123;</span><br><span class="line">    buf<span class="built_in">.</span>writeByte(<span class="string">'*'</span>);</span><br><span class="line">    Utils<span class="built_in">.</span>writeLongAsString(buf, <span class="number">1</span> <span class="subst">+</span> (args <span class="subst">!=</span> <span class="built_in">null</span> <span class="subst">?</span> args<span class="built_in">.</span>count() : <span class="number">0</span>));</span><br><span class="line">    buf<span class="built_in">.</span>writeBytes(Utils<span class="built_in">.</span>CrLf);</span><br><span class="line">    buf<span class="built_in">.</span>writeByte(<span class="string">'$'</span>);</span><br><span class="line">    Utils<span class="built_in">.</span>writeLongAsString(buf, <span class="keyword">type</span><span class="built_in">.</span><span class="built_in">bytes</span><span class="built_in">.</span>length);</span><br><span class="line">    buf<span class="built_in">.</span>writeBytes(Utils<span class="built_in">.</span>CrLf);</span><br><span class="line">    buf<span class="built_in">.</span>writeBytes(<span class="keyword">type</span><span class="built_in">.</span><span class="built_in">bytes</span>);</span><br><span class="line">    buf<span class="built_in">.</span>writeBytes(Utils<span class="built_in">.</span>CrLf);</span><br><span class="line">    <span class="keyword">if</span> (args <span class="subst">!=</span> <span class="built_in">null</span>) &#123;</span><br><span class="line">        buf<span class="built_in">.</span>writeBytes(args<span class="built_in">.</span>buffer());</span><br><span class="line">        args<span class="built_in">.</span>release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="验证">验证</h3><p>　　好，改完了验证一下。写个循环申请500M内存，分别不release和release，然后sleep住，并用jmap将内存dump出来用mat查看，得到下列两幅图，验证成功。<br><img src="http://lyso.qiniudn.com/memleak.5.png" alt="不进行release的内存使用"><br><img src="http://lyso.qiniudn.com/memleak.6.png" alt="进行release的内存使用"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2014/07/01/bytebuf-memleak/" data-id="ci7zkady50048r158ejjot53b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ByteBuf/">ByteBuf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MAT/">MAT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NIO/">NIO</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Netty/">Netty</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PolledByteBufAllocator/">PolledByteBufAllocator</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jhat/">jhat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jmap/">jmap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内存泄露/">内存泄露</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-after-dine-with-classmates" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/06/28/after-dine-with-classmates/" class="article-date">
  <time datetime="2014-06-28T15:22:11.000Z" itemprop="datePublished">2014-06-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/06/28/after-dine-with-classmates/">餐后小记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>　　十几个同学的聚会，顺便去车库咖啡聊聊天，装模作样的码了几百行代码，才发现我这已有一年多的时间“两耳不闻屏外事，一心只做程序员”了。偏信则暗兼听则明，那段时间内跟好多前辈和朋友聊天，收获颇丰，记得跟本来生活喻华峰聊后写了一篇日志总结当时的心情。这一年多来自己在技术上有了很多的进步和收获，但似乎也局限了思考问题的角度。我本以为自己会是安心做事专研一术，但时代似乎给我们这代人的压力让我们变得浮躁和急功近利，尤其再加上传统家庭观念中生养相关的一系列待解决的问题。以前我也爱说，“钱能解决的问题都不是问题”，但面前摆着一坨需要钱才能解决的问题时，跟自己谈理想时自己都觉得心虚。前段时间领导说“如果像你这样有能力又上进的好员工都不能得到应有的，那这个社会太不公太操蛋了”让我鼻子猛的发酸，冷静下来想想这社会的确处处有着不公和操蛋。天航今天在车里问，人活着图个什么，我没答案，说不图什么。但我觉得人在做的，是自己逼自己，逼自己多想想多看看多动动多做点什么，让自己担负起社会和家庭责任之余能留出一片做梦的空白，免得走的太慢而被现实逼疯。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyso.me/2014/06/28/after-dine-with-classmates/" data-id="ci7zkadye0056r158uzr1rkl2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/80后/">80后</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/人生/">人生</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/现实/">现实</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/理想/">理想</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/80后/">80后</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ByteBuf/">ByteBuf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dota/">Dota</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FSM/">FSM</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google-Sync/">Google Sync</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/">HBase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jekyll/">Jekyll</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MAT/">MAT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/">NIO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/">Netty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PolledByteBufAllocator/">PolledByteBufAllocator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Reactive-Streams/">Reactive Streams</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/actor模型/">actor模型</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/back-pressure/">back pressure</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/erlang/">erlang</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github-pages/">github pages</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hbase-batch/">hbase-batch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java内存模型/">java内存模型</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java线程模型/">java线程模型</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jhat/">jhat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jmap/">jmap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/little-s-law/">little's law</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mampa/">mampa</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/queueing-threory/">queueing threory</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reactive-streams/">reactive streams</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reactor/">reactor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis-pipline/">redis pipline</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/三体/">三体</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/丛林法则/">丛林法则</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/亚军/">亚军</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/人生/">人生</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存泄露/">内存泄露</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/创业/">创业</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/利特尔法则/">利特尔法则</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/喻华峰/">喻华峰</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小米/">小米</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小米推送系统/">小米推送系统</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小米羽毛球联赛/">小米羽毛球联赛</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发/">并发</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源/">开源</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异步/">异步</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异步HBase客户端/">异步HBase客户端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异步Redis客户端/">异步Redis客户端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排队理论/">排队理论</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/无锁/">无锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/有限状态机/">有限状态机</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/本来生活/">本来生活</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/泊松过程/">泊松过程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/现实/">现实</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/理想/">理想</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/生命/">生命</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/米莱/">米莱</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/羽毛球/">羽毛球</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/翻墙/">翻墙</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/职业规划/">职业规划</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/豆芽/">豆芽</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/负指数分布/">负指数分布</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/队列/">队列</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/马尔科夫链/">马尔科夫链</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/黑暗森林/">黑暗森林</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/80后/" style="font-size: 10px;">80后</a><a href="/tags/ByteBuf/" style="font-size: 10px;">ByteBuf</a><a href="/tags/Dota/" style="font-size: 10px;">Dota</a><a href="/tags/FSM/" style="font-size: 15px;">FSM</a><a href="/tags/Google-Sync/" style="font-size: 10px;">Google Sync</a><a href="/tags/HBase/" style="font-size: 10px;">HBase</a><a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a><a href="/tags/Jekyll/" style="font-size: 10px;">Jekyll</a><a href="/tags/MAT/" style="font-size: 10px;">MAT</a><a href="/tags/NIO/" style="font-size: 10px;">NIO</a><a href="/tags/Netty/" style="font-size: 10px;">Netty</a><a href="/tags/PolledByteBufAllocator/" style="font-size: 10px;">PolledByteBufAllocator</a><a href="/tags/Reactive-Streams/" style="font-size: 10px;">Reactive Streams</a><a href="/tags/Redis/" style="font-size: 10px;">Redis</a><a href="/tags/actor模型/" style="font-size: 15px;">actor模型</a><a href="/tags/back-pressure/" style="font-size: 10px;">back pressure</a><a href="/tags/erlang/" style="font-size: 15px;">erlang</a><a href="/tags/github-pages/" style="font-size: 10px;">github pages</a><a href="/tags/go/" style="font-size: 10px;">go</a><a href="/tags/golang/" style="font-size: 10px;">golang</a><a href="/tags/hbase-batch/" style="font-size: 10px;">hbase-batch</a><a href="/tags/java内存模型/" style="font-size: 15px;">java内存模型</a><a href="/tags/java线程模型/" style="font-size: 15px;">java线程模型</a><a href="/tags/jhat/" style="font-size: 10px;">jhat</a><a href="/tags/jmap/" style="font-size: 10px;">jmap</a><a href="/tags/little-s-law/" style="font-size: 10px;">little's law</a><a href="/tags/mampa/" style="font-size: 15px;">mampa</a><a href="/tags/netty/" style="font-size: 10px;">netty</a><a href="/tags/queueing-threory/" style="font-size: 10px;">queueing threory</a><a href="/tags/reactive-streams/" style="font-size: 10px;">reactive streams</a><a href="/tags/reactor/" style="font-size: 10px;">reactor</a><a href="/tags/redis-pipline/" style="font-size: 10px;">redis pipline</a><a href="/tags/三体/" style="font-size: 12.5px;">三体</a><a href="/tags/丛林法则/" style="font-size: 12.5px;">丛林法则</a><a href="/tags/亚军/" style="font-size: 10px;">亚军</a><a href="/tags/人生/" style="font-size: 12.5px;">人生</a><a href="/tags/内存泄露/" style="font-size: 12.5px;">内存泄露</a><a href="/tags/创业/" style="font-size: 15px;">创业</a><a href="/tags/利特尔法则/" style="font-size: 10px;">利特尔法则</a><a href="/tags/喻华峰/" style="font-size: 10px;">喻华峰</a><a href="/tags/小米/" style="font-size: 10px;">小米</a><a href="/tags/小米推送系统/" style="font-size: 10px;">小米推送系统</a><a href="/tags/小米羽毛球联赛/" style="font-size: 10px;">小米羽毛球联赛</a><a href="/tags/并发/" style="font-size: 20px;">并发</a><a href="/tags/开源/" style="font-size: 17.5px;">开源</a><a href="/tags/异步/" style="font-size: 20px;">异步</a><a href="/tags/异步HBase客户端/" style="font-size: 10px;">异步HBase客户端</a><a href="/tags/异步Redis客户端/" style="font-size: 10px;">异步Redis客户端</a><a href="/tags/排队理论/" style="font-size: 10px;">排队理论</a><a href="/tags/无锁/" style="font-size: 10px;">无锁</a><a href="/tags/有限状态机/" style="font-size: 15px;">有限状态机</a><a href="/tags/本来生活/" style="font-size: 10px;">本来生活</a><a href="/tags/泊松过程/" style="font-size: 10px;">泊松过程</a><a href="/tags/现实/" style="font-size: 10px;">现实</a><a href="/tags/理想/" style="font-size: 10px;">理想</a><a href="/tags/生命/" style="font-size: 10px;">生命</a><a href="/tags/米莱/" style="font-size: 10px;">米莱</a><a href="/tags/羽毛球/" style="font-size: 10px;">羽毛球</a><a href="/tags/翻墙/" style="font-size: 10px;">翻墙</a><a href="/tags/职业规划/" style="font-size: 15px;">职业规划</a><a href="/tags/豆芽/" style="font-size: 10px;">豆芽</a><a href="/tags/负指数分布/" style="font-size: 10px;">负指数分布</a><a href="/tags/队列/" style="font-size: 10px;">队列</a><a href="/tags/马尔科夫链/" style="font-size: 10px;">马尔科夫链</a><a href="/tags/黑暗森林/" style="font-size: 12.5px;">黑暗森林</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">六月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">五月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">三月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">十一月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/01/">一月 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/11/">十一月 2010</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/04/02/1/">test</a>
          </li>
        
          <li>
            <a href="/2015/04/02/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2015/01/02/douya/">小豆芽表情九连拍</a>
          </li>
        
          <li>
            <a href="/2014/08/27/reactor/">reactor代码浅析</a>
          </li>
        
          <li>
            <a href="/2014/08/26/backpressure/">back pressure及reactive streams研究</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 leoyonn<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>